<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SB DINÁMICAS - Sorteos Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #f43f5e;
            --accent-dark: #e11d48;
            --success: #22c55e;
            --success-dark: #16a34a;
            --warning: #fbbf24;
            --warning-dark: #f59e0b;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-dark: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
            --color-libre: rgba(255, 255, 255, 0.03);
            --color-seleccionado: #6366f1;
            --color-apartado: #fbbf24;
            --color-pagado: #22c55e;
            --bg-gradient: radial-gradient(circle at top right, #0f172a, #020617);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            padding: 15px;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(244, 63, 94, 0.1) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }
        
        /* ANIMACIONES */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 3px var(--accent); }
            50% { box-shadow: 0 0 0 6px var(--accent); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* GLASS EFFECT PREMIUM */
        .glass-effect {
            background: var(--glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .glass-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.05),
                transparent
            );
            transition: left 0.6s ease;
        }
        
        .glass-effect:hover::before {
            left: 100%;
        }
        
        header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            background: linear-gradient(135deg, #fbbf24, #22c55e, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, transparent, #6366f1, transparent);
            border-radius: 2px;
        }
        
        /* BUSCADOR PREMIUM */
        .quick-search-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 0 5px;
        }
        
        .search-input-group {
            flex: 1;
            position: relative;
        }
        
        .search-input {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid transparent;
            padding: 14px 45px 14px 15px;
            border-radius: 14px;
            color: white;
            width: 100%;
            outline: none;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)) padding-box,
                      linear-gradient(135deg, var(--primary), var(--accent)) border-box;
        }
        
        .search-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* BOTONES PREMIUM */
        .btn {
            padding: 14px 24px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1), 
                rgba(255, 255, 255, 0.05));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn:hover::before {
            opacity: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 10px 30px rgba(99, 102, 241, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
            width: 100%;
            font-size: 1.1rem;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
        }
        
        .btn-quick {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-quick:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        /* GRID DE NÚMEROS PREMIUM */
        .numbers-container {
            height: 420px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
            margin-bottom: 20px;
        }
        
        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            gap: 10px;
        }
        
        .number-item {
            aspect-ratio: 1;
            background: var(--color-libre);
            border: 2px solid transparent;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .number-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                transparent,
                rgba(255, 255, 255, 0.05),
                transparent
            );
            transform: translateX(-100%);
        }
        
        .number-item:hover::before {
            animation: shimmer 1s ease;
        }
        
        .number-item:hover {
            transform: translateY(-3px) scale(1.05);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .number-item.selected {
            background: linear-gradient(135deg, var(--color-seleccionado), #4f46e5);
            color: white;
            border: none;
            transform: scale(1.08);
            box-shadow: 
                0 0 25px var(--color-seleccionado),
                0 8px 20px rgba(99, 102, 241, 0.4);
            animation: float 3s ease-in-out infinite;
        }
        
        .number-item.apartado {
            background: linear-gradient(135deg, var(--color-apartado), #f59e0b);
            color: #000;
            cursor: not-allowed;
            border: none;
        }
        
        .number-item.pagado {
            background: linear-gradient(135deg, var(--color-pagado), #16a34a);
            color: #fff;
            cursor: not-allowed;
            border: none;
        }
        
        .number-item.highlighted {
            box-shadow: 0 0 0 3px var(--accent);
            border-color: var(--accent);
            z-index: 10;
            animation: pulse 2s infinite;
        }
        
        .number-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--accent);
            color: white;
            font-size: 0.55rem;
            padding: 3px 5px;
            border-radius: 6px;
            font-weight: 900;
            min-width: 18px;
            text-align: center;
            box-shadow: 0 3px 8px rgba(244, 63, 94, 0.4);
        }
        
        /* PANEL ADMIN PREMIUM */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 18px;
            border: 1px solid var(--glass-border);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        /* TABLAS PREMIUM */
        .admin-table-container {
            overflow-x: auto;
            margin-top: 15px;
            max-height: 450px;
            overflow-y: auto;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        thead {
            background: rgba(99, 102, 241, 0.1);
            border-bottom: 2px solid var(--glass-border);
        }
        
        th {
            padding: 16px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* BADGES PREMIUM */
        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            display: inline-block;
        }
        
        .bg-wait {
            background: linear-gradient(135deg, var(--warning), var(--warning-dark));
            color: #000;
        }
        
        .bg-paid {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: #fff;
        }
        
        /* PROGRESS BAR PREMIUM */
        .progress-bar-bg {
            background: rgba(0, 0, 0, 0.4);
            height: 22px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
            border: 1px solid var(--glass-border);
        }
        
        .progress-bar-fill {
            background: linear-gradient(90deg, 
                #fbbf24, 
                #22c55e,
                #6366f1);
            height: 100%;
            width: 0%;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite linear;
        }
        
        /* FORMULARIOS PREMIUM */
        input, textarea {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 12px;
            color: white;
            width: 100%;
            outline: none;
            margin-bottom: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)) padding-box,
                      linear-gradient(135deg, var(--glass-border), transparent) border-box;
        }
        
        input:focus, textarea:focus {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-secondary);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        /* LOADING STATES */
        .spinner {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }
        
        /* UTILITIES */
        .hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* SCROLLBAR PERSONALIZADA */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(var(--primary), var(--accent));
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.2);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(var(--primary-dark), var(--accent-dark));
        }
        
        /* NOTIFICACIONES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 350px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 4px solid var(--success);
        }
        
        .notification.error {
            border-left: 4px solid var(--accent);
        }
        
        .notification.warning {
            border-left: 4px solid var(--warning);
        }
        
        /* CONFIG ALERT PREMIUM */
        .config-alert {
            background: linear-gradient(135deg, 
                rgba(251, 191, 36, 0.1), 
                rgba(251, 191, 36, 0.05));
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .config-alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--warning), transparent);
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .numbers-grid {
                grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
                gap: 8px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .quick-search-container,
            .quick-select-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-clear-btn,
            .btn-quick {
                width: 100%;
                justify-content: center;
            }
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: slideInUp 0.6s ease-out;
        }
        
        /* ESTADO DE CONEXIÓN */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            animation: fadeIn 0.5s ease-out;
        }
        
        .connection-status.online {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .connection-status.offline {
            background: rgba(244, 63, 94, 0.15);
            color: #f43f5e;
            border-color: rgba(244, 63, 94, 0.3);
        }
        
        .connection-status.syncing {
            background: rgba(99, 102, 241, 0.15);
            color: #6366f1;
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-dot.online {
            background: #22c55e;
            box-shadow: 0 0 10px #22c55e;
        }
        
        .status-dot.offline {
            background: #f43f5e;
        }
        
        .status-dot.syncing {
            background: #6366f1;
            animation: pulse 1.5s infinite;
        }
        
        /* VALIDACIONES */
        .input-valid {
            border-color: var(--success) !important;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)) padding-box,
                        linear-gradient(135deg, var(--success), transparent) border-box !important;
        }
        
        .input-invalid {
            border-color: var(--accent) !important;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)) padding-box,
                        linear-gradient(135deg, var(--accent), transparent) border-box !important;
            animation: shake 0.5s ease-in-out;
        }
        
        .validation-message {
            font-size: 0.8rem;
            margin-top: -8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            display: none;
        }
        
        .validation-success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
            display: block;
        }
        
        .validation-error {
            background: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            border: 1px solid rgba(244, 63, 94, 0.3);
            display: block;
        }
        
        /* MODAL DE PAGO */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease-out;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .payment-method {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-method:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }
        
        .payment-method.selected {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3);
        }
        
        /* BADGES DE SEGURIDAD */
        .security-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-left: 8px;
        }
        
        .badge-safe {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
        }
        
        .badge-warning {
            background: linear-gradient(135deg, var(--warning), var(--warning-dark));
            color: black;
        }
        
        .badge-danger {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
        }
    </style>
</head>
<body>
    <!-- Indicador de conexión -->
    <div id="connectionStatus" class="connection-status hidden">
        <span class="status-dot"></span>
        <span id="connectionText">Conectando...</span>
    </div>
    
    <!-- NOTIFICACIONES -->
    <div id="notification" class="notification hidden"></div>
    
    <!-- MODALES -->
    <div id="whatsappConfirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 style="color: white; margin-bottom: 20px; text-align: center;">
                <i class="fab fa-whatsapp"></i> Confirmar Reserva
            </h2>
            <div id="whatsappDetails"></div>
            <button class="btn btn-primary" onclick="sendWhatsAppReservation()" style="width: 100%; margin-top: 20px;">
                <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
            </button>
            <button class="btn" onclick="closeModal('whatsappConfirmationModal')" 
                    style="width: 100%; margin-top: 10px; background: none; color: var(--text-secondary);">
                Cancelar
            </button>
        </div>
    </div>
    
    <div id="paymentModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 style="color: white; margin-bottom: 25px; text-align: center;">
                <i class="fas fa-credit-card"></i> Método de Pago
            </h2>
            
            <div style="margin-bottom: 25px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px;">
                <div style="color: var(--text-secondary); margin-bottom: 10px;">Resumen:</div>
                <div id="paymentSummary"></div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 25px;">
                <div class="payment-method" onclick="selectPaymentMethod('transfer')">
                    <i class="fas fa-university" style="font-size: 2rem; color: var(--primary);"></i>
                    <span style="color: white; font-weight: 600;">Transferencia</span>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('nequi')">
                    <i class="fas fa-mobile-alt" style="font-size: 2rem; color: #00CC99;"></i>
                    <span style="color: white; font-weight: 600;">Nequi</span>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('daviplata')">
                    <i class="fas fa-wallet" style="font-size: 2rem; color: #FF6B6B;"></i>
                    <span style="color: white; font-weight: 600;">DaviPlata</span>
                </div>
                
                <div class="payment-method" onclick="selectPaymentMethod('efecty')">
                    <i class="fas fa-store" style="font-size: 2rem; color: #FBBF24;"></i>
                    <span style="color: white; font-weight: 600;">Efecty</span>
                </div>
            </div>
            
            <div id="paymentDetails" style="display: none; margin-bottom: 20px;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px;">
                    <h4 style="color: white; margin-bottom: 10px;" id="paymentMethodTitle"></h4>
                    <div id="paymentInstructions"></div>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="confirmPayment()" style="width: 100%;" id="confirmPaymentBtn">
                <i class="fas fa-check-circle"></i> Confirmar Pago
            </button>
            
            <button class="btn" onclick="closeModal('paymentModal')" 
                    style="width: 100%; margin-top: 10px; background: none; color: var(--text-secondary);">
                Cancelar
            </button>
        </div>
    </div>
    
    <div class="container">
        <!-- HEADER PREMIUM -->
        <header>
            <div style="position: relative;">
                <h1>SB DINÁMICAS</h1>
                <p style="color: var(--text-secondary); margin-top: 15px; font-size: 1rem;">
                    <i class="fas fa-gem" style="color: var(--primary); margin-right: 8px;"></i>
                    Plataforma premium de sorteos
                </p>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showTab('user')">
                    <i class="fas fa-ticket-alt"></i> Participar
                </button>
                <button class="btn btn-primary" onclick="showTab('admin-login')">
                    <i class="fas fa-lock"></i> Admin
                </button>
                <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="showInstructions()">
                    <i class="fas fa-question-circle"></i> Ayuda
                </button>
            </div>
        </header>
        
        <!-- VISTA USUARIO -->
        <div id="view-user" class="fade-in">
            <!-- PANEL PREMIO -->
            <div class="glass-effect">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <h2 id="displayPrizeTitle" style="font-size: 1.8rem; background: linear-gradient(135deg, #fbbf24, #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
                        Cargando sorteo...
                    </h2>
                    <span style="background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                        <i class="fas fa-fire"></i> ACTIVO
                    </span>
                </div>
                
                <div id="prizeImageContainer" style="display: none; margin: 20px 0;">
                    <img id="displayPrizeImg" style="width:100%; height:280px; object-fit:cover; border-radius:16px; border: 2px solid var(--glass-border);">
                </div>
                
                <p id="displayPrizeDesc" style="color:var(--text-secondary); font-size: 1rem; line-height: 1.6; margin-bottom: 20px;"></p>
                
                <div id="contadorSorteo"></div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color:var(--warning); margin-bottom: 5px;">
                                <i class="fas fa-ticket-alt"></i> Valor por boleto:
                            </h3>
                            <div style="font-size: 2.2rem; font-weight: 800; color: white;">
                                $<span id="displayPrice">0</span> <small style="font-size: 1rem; color: var(--text-secondary);">COP</small>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">
                                <i class="fas fa-bolt"></i> Rápido y seguro
                            </div>
                            <div style="font-size: 0.8rem; color: var(--primary);">
                                <i class="fas fa-shield-alt"></i> Transacción protegida
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ALERTA WHATSAPP -->
                <div id="whatsappAlert" class="config-alert hidden">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 1.5rem; margin-bottom: 10px;"></i>
                    <p><strong style="color: white; font-size: 1.1rem;">⚠️ WhatsApp no configurado</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: var(--text-secondary);">
                        El administrador debe configurar el número de WhatsApp para poder apartar números.
                        <br>
                        <small style="opacity: 0.8;">Por favor, contacta al organizador del sorteo.</small>
                    </p>
                </div>
            </div>
            
            <!-- PANEL SELECCIÓN DE NÚMEROS -->
            <div class="glass-effect">
                <!-- BUSCADOR RÁPIDO -->
                <div class="quick-search-container">
                    <div class="search-input-group">
                        <input type="text" 
                               class="search-input" 
                               id="numberSearch" 
                               placeholder="Buscar número (Ej: 001, 123...)"
                               maxlength="3"
                               oninput="searchNumbers()">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <button class="search-clear-btn btn" onclick="clearSearch()" style="background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.1)); border: 1px solid rgba(244, 63, 94, 0.3); color: #fb7185;">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
                
                <!-- RESULTADOS DE BÚSQUEDA -->
                <div id="searchResultsInfo" class="search-results-info hidden" style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; margin: 15px 0; text-align: center; color: var(--text-secondary); font-size: 0.9rem;"></div>
                
                <!-- SELECCIÓN RÁPIDA -->
                <div class="quick-select-container" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 0 5px;">
                    <span class="quick-label" style="font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-dice"></i> Selección rápida:
                    </span>
                    <div class="quick-group" style="display: flex; gap: 8px;">
                        <button class="btn-quick" onclick="selectRandom(5)">
                            <i class="fas fa-random"></i> 5
                        </button>
                        <button class="btn-quick" onclick="selectRandom(10)">10</button>
                        <button class="btn-quick" onclick="selectRandom(20)">20</button>
                        <button class="btn-quick" onclick="clearSelection()" style="background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.1)); border-color: rgba(244, 63, 94, 0.3); color: #fb7185;">
                            <i class="fas fa-undo"></i> Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- CONTENEDOR DE NÚMEROS -->
                <div class="numbers-container">
                    <div class="numbers-grid" id="mainGrid"></div>
                </div>
                
                <!-- LEYENDA DE COLORES -->
                <div class="legend-container" style="display: flex; justify-content: center; gap: 25px; margin-top: 25px; flex-wrap: wrap;">
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <span class="legend-color" style="width: 14px; height: 14px; border-radius: 4px; background: var(--color-libre); border: 1px solid var(--glass-border);"></span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Disponible</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <span class="legend-color" style="width: 14px; height: 14px; border-radius: 4px; background: linear-gradient(135deg, var(--color-seleccionado), #4f46e5);"></span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Seleccionado</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <span class="legend-color" style="width: 14px; height: 14px; border-radius: 4px; background: linear-gradient(135deg, var(--color-apartado), #f59e0b);"></span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Apartado</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <span class="legend-color" style="width: 14px; height: 14px; border-radius: 4px; background: linear-gradient(135deg, var(--color-pagado), #16a34a);"></span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Pagado</span>
                    </div>
                </div>
                
                <!-- RESUMEN DE SELECCIÓN -->
                <div id="selectionSummary" style="margin: 25px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 16px; border: 1px solid var(--glass-border); min-height: 60px; text-align: center;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> Selecciona tus números
                    </div>
                </div>
            </div>
            
            <!-- FORMULARIO DE USUARIO -->
            <div class="glass-effect">
                <h3 style="color: white; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-user-circle"></i> Tus Datos
                </h3>
                
                <div class="form-user">
                    <input type="text" id="uNombre" placeholder="Nombre completo *" required oninput="validateField(this, 'name')">
                    <div id="nombreValidation" class="validation-message"></div>
                    
                    <input type="text" id="uCiudad" placeholder="Ciudad (Ej: Cali) *" required oninput="validateField(this, 'city')">
                    <div id="ciudadValidation" class="validation-message"></div>
                    
                    <input type="tel" id="uCelular" placeholder="Celular (Ej: 3001234567) *" required pattern="[0-9]{10}" maxlength="10" oninput="validateField(this, 'phone')">
                    <div id="celularValidation" class="validation-message"></div>
                </div>
                
                <div style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 0.85rem;">
                        <i class="fas fa-shield-alt" style="color: var(--primary);"></i>
                        <span>Tus datos están protegidos y solo se usarán para el sorteo.</span>
                    </div>
                </div>
                
                <!-- BOTÓN DE ACCIÓN PRINCIPAL -->
                <button class="btn btn-success" onclick="validateAndReserve()" id="btnAction">
                    <i class="fas fa-shopping-cart"></i> PROCEDER CON LA RESERVA
                    <span id="selectedCountBadge" style="background: white; color: var(--success-dark); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 8px; display: none;">0</span>
                </button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">
                        <i class="fas fa-clock"></i> La reserva es válida por 24 horas
                    </small>
                </div>
            </div>
        </div>
        
        <!-- VISTA LOGIN ADMIN -->
        <div id="view-admin-login" class="hidden">
            <div class="glass-effect" style="max-width: 400px; margin: 40px auto;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <i class="fas fa-lock" style="color: white; font-size: 2rem;"></i>
                    </div>
                    <h2 style="color: white; font-size: 1.8rem;">Acceso Administrador</h2>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Ingresa tus credenciales</p>
                </div>
                
                <input type="email" id="adminEmail" placeholder="Correo electrónico" required>
                <input type="password" id="adminPass" placeholder="Contraseña" required>
                
                <button class="btn btn-primary" style="width:100%; margin-top: 25px;" onclick="adminLogin()">
                    <span id="loginText">Entrar al Panel</span>
                    <span id="loginSpinner" class="spinner hidden" style="margin-left: 10px;"></span>
                </button>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" style="background: none; color: var(--text-secondary); font-size: 0.9rem;" onclick="showTab('user')">
                        <i class="fas fa-arrow-left"></i> Volver al sorteo
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PANEL ADMIN -->
        <div id="view-admin-panel" class="hidden">
            <!-- PANEL DE SEGURIDAD -->
            <div class="glass-effect" style="margin-top: 20px; display: none;" id="securityPanel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: white; font-size: 1.3rem;">
                        <i class="fas fa-shield-alt"></i> Panel de Seguridad
                    </h3>
                    <button class="btn-quick" onclick="refreshSecurityPanel()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <!-- Estadísticas de seguridad -->
                <div class="admin-stats">
                    <div class="stat-card">
                        <h4><i class="fas fa-ban"></i> Bloqueados</h4>
                        <p id="statBlocked" style="color: var(--accent); font-size: 1.8rem; font-weight: 800;">0</p>
                        <small>IPs bloqueadas</small>
                    </div>
                    
                    <div class="stat-card">
                        <h4><i class="fas fa-exclamation-triangle"></i> Intentos</h4>
                        <p id="statAttempts" style="color: var(--warning); font-size: 1.8rem; font-weight: 800;">0</p>
                        <small>Intentos fallidos (24h)</small>
                    </div>
                    
                    <div class="stat-card">
                        <h4><i class="fas fa-user-clock"></i> Activos</h4>
                        <p id="statActive" style="color: var(--primary); font-size: 1.8rem; font-weight: 800;">0</p>
                        <small>Usuarios activos hoy</small>
                    </div>
                    
                    <div class="stat-card">
                        <h4><i class="fas fa-robot"></i> Sospechosos</h4>
                        <p id="statSuspicious" style="color: #f97316; font-size: 1.8rem; font-weight: 800;">0</p>
                        <small>Actividad sospechosa</small>
                    </div>
                </div>
                
                <!-- Lista de IPs bloqueadas -->
                <div style="margin-top: 25px;">
                    <h4 style="color: white; margin-bottom: 15px;">
                        <i class="fas fa-list"></i> IPs Bloqueadas Actualmente
                    </h4>
                    <div id="blockedIPsList" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; 
                         max-height: 200px; overflow-y: auto; border: 1px solid var(--glass-border);">
                        <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                            No hay IPs bloqueadas
                        </div>
                    </div>
                </div>
                
                <!-- Acciones de seguridad -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">
                    <button class="btn" onclick="clearAllBlocks()" 
                            style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.1)); 
                                   border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e;">
                        <i class="fas fa-unlock"></i> Desbloquear Todo
                    </button>
                    
                    <button class="btn" onclick="exportSecurityLog()" 
                            style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.1)); 
                                   border: 1px solid rgba(99, 102, 241, 0.3); color: #a5b4fc;">
                        <i class="fas fa-download"></i> Exportar Logs
                    </button>
                </div>
                
                <!-- Botón para mostrar/ocultar detalles -->
                <button class="btn" onclick="toggleSecurityDetails()" 
                        style="width: 100%; margin-top: 15px; background: rgba(255,255,255,0.05);">
                    <i class="fas fa-eye"></i> Mostrar Detalles de Seguridad
                </button>
                
                <!-- Detalles expandidos (oculto por defecto) -->
                <div id="securityDetails" style="display: none; margin-top: 20px; padding-top: 20px; 
                     border-top: 1px solid var(--glass-border);">
                    <h4 style="color: white; margin-bottom: 15px;">
                        <i class="fas fa-chart-bar"></i> Estadísticas Detalladas
                    </h4>
                    <div id="securityStatsDetails"></div>
                </div>
            </div>
            
            <!-- ESTADÍSTICAS PRINCIPALES -->
            <div class="admin-stats">
                <div class="stat-card">
                    <h4 style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px;">
                        <i class="fas fa-check-circle"></i> Confirmado
                    </h4>
                    <p id="statRecaudado" style="font-size: 1.8rem; font-weight: 800; color: var(--success); margin: 5px 0;">$0</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Total recaudado</small>
                </div>
                <div class="stat-card">
                    <h4 style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px;">
                        <i class="fas fa-clock"></i> Por Cobrar
                    </h4>
                    <p id="statPendiente" style="font-size: 1.8rem; font-weight: 800; color: var(--warning); margin: 5px 0;">$0</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Pendiente de pago</small>
                </div>
                <div class="stat-card">
                    <h4 style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px;">
                        <i class="fas fa-chart-pie"></i> Vendidos
                    </h4>
                    <p id="statVendidos" style="font-size: 1.8rem; font-weight: 800; color: var(--primary); margin: 5px 0;">0/1000</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Números ocupados</small>
                </div>
                <div class="stat-card">
                    <h4 style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px;">
                        <i class="fas fa-users"></i> Participantes
                    </h4>
                    <p id="statParticipantes" style="font-size: 1.8rem; font-weight: 800; color: var(--accent); margin: 5px 0;">0</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Total participantes</small>
                </div>
            </div>
            
            <!-- PANEL PRINCIPAL ADMIN -->
            <div class="glass-effect">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="color: white; font-size: 1.5rem;">
                        <i class="fas fa-chart-line"></i> Gestión de Ventas
                    </h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="securityToggleBtn" class="btn-quick" onclick="toggleSecurityPanel()" title="Panel de Seguridad">
                            <i class="fas fa-shield-alt"></i>
                        </button>
                        <button class="btn-quick" onclick="exportToExcel()" title="Exportar a Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                        <button class="btn-quick" onclick="showTab('admin-config')">
                            <i class="fas fa-cog"></i> Configurar
                        </button>
                    </div>
                </div>
                
                <!-- BARRA DE PROGRESO -->
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">Progreso del sorteo</span>
                        <span id="progText" style="font-size: 0.9rem; font-weight: 700; color: var(--primary);">0/1000 (0%)</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progFill"></div>
                    </div>
                </div>
                
                <!-- BUSCADOR ADMIN -->
                <input type="text" id="adminSearch" placeholder="🔍 Buscar por número, nombre o ciudad..." oninput="updateAdminPanel()" style="margin-bottom: 20px;">
                
                <!-- TABLA DE VENTAS -->
                <div class="admin-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Participante</th>
                                <th>Celular</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable"></tbody>
                    </table>
                </div>
                
                <!-- BOTONES DE ACCIÓN -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 25px;">
                    <button class="btn" onclick="showTab('admin-config')" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.1)); border: 1px solid rgba(99, 102, 241, 0.3); color: #a5b4fc;">
                        <i class="fas fa-cog"></i> Configurar
                    </button>
                    <button class="btn" onclick="clearAllData()" style="background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.1)); border: 1px solid rgba(244, 63, 94, 0.3); color: #fb7185;">
                        <i class="fas fa-trash"></i> Resetear Todo
                    </button>
                </div>
                
                <button class="btn sync-btn" onclick="forceSync()" 
                        style="width:100%; margin-top:15px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color:white; border: none;">
                    <i class="fas fa-sync-alt"></i> Sincronizar con Firebase
                </button>
                
                <button class="btn" onclick="adminLogout()" style="width:100%; margin-top:10px; background:none; color:var(--text-secondary); border: 1px solid var(--glass-border);">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </div>
        
        <!-- CONFIGURACIÓN ADMIN -->
        <div id="view-admin-config" class="hidden">
            <!-- CONFIGURACIÓN COMPLETA DEL SORTEO -->
            <div class="glass-effect">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="color: white; font-size: 1.5rem;">
                        <i class="fas fa-cogs"></i> Configuración Completa del Sorteo
                    </h3>
                    <button class="btn-quick" onclick="showTab('admin-panel')">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
                
                <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; color: var(--warning);">
                        <i class="fas fa-info-circle"></i>
                        <span style="font-size: 0.9rem;">Configura todos los detalles del sorteo que verán los participantes</span>
                    </div>
                </div>
                
                <div class="form-user">
                    <!-- TÍTULO PRINCIPAL -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-heading"></i> Título Principal *
                        </label>
                        <input type="text" 
                               id="configTitulo" 
                               placeholder="Ej: GRAN SORTEO ANIVERSARIO SB DINÁMICAS"
                               maxlength="100"
                               style="font-size: 1.1rem; font-weight: 600;">
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Este es el título principal que verán los participantes (máx. 100 caracteres)
                        </small>
                    </div>
                    
                    <!-- SUBTÍTULO O DESCRIPCIÓN -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-align-left"></i> Descripción / Subtítulo *
                        </label>
                        <textarea id="configDescripcion" 
                                  placeholder="Describe el premio, condiciones y detalles importantes del sorteo..."></textarea>
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Describe el premio principal, reglas del sorteo y cualquier información relevante
                        </small>
                    </div>
                    
                    <!-- VALOR DEL BOLETO -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-tag"></i> Valor por Boleto *
                        </label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: white; font-weight: 600;">$</span>
                            <input type="number" 
                                   id="configValor" 
                                   placeholder="Ej: 20000"
                                   min="1000" 
                                   step="1000"
                                   style="flex: 1;">
                            <span style="color: var(--text-secondary);">COP</span>
                        </div>
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Precio que pagarán los participantes por cada número (mínimo $1,000)
                        </small>
                    </div>
                    
                    <!-- FECHA DEL SORTEO -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-calendar-alt"></i> Fecha del Sorteo *
                        </label>
                        <input type="datetime-local" id="configFecha">
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Fecha y hora en que se realizará el sorteo. Los participantes verán un contador.
                        </small>
                    </div>
                    
                    <!-- PIE DE PÁGINA / INFORMACIÓN ADICIONAL -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-file-alt"></i> Información Adicional / Pie de Página
                        </label>
                        <textarea id="configPiePagina" 
                                  placeholder="Información adicional, términos y condiciones, métodos de pago, contacto..."></textarea>
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Información que aparecerá en la parte inferior. Puedes incluir términos, condiciones y datos de contacto.
                        </small>
                    </div>
                    
                    <!-- IMAGEN DEL PREMIO -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-image"></i> Imagen del Premio
                        </label>
                        <div style="border: 2px dashed var(--glass-border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; position: relative;"
                             onclick="document.getElementById('configImagenFile').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <div style="color: white; font-weight: 600; margin-bottom: 5px;">Subir Imagen del Premio</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">
                                Haz clic para seleccionar una imagen (JPG, PNG, GIF - Máx. 5MB)
                            </div>
                            <input type="file" 
                                   id="configImagenFile" 
                                   accept="image/*" 
                                   onchange="uploadConfigImage(this)"
                                   style="display: none;">
                        </div>
                        
                        <!-- VISTA PREVIA DE LA IMAGEN -->
                        <div id="configImagenPreview" style="margin-top: 15px; display: none;">
                            <div style="color: white; margin-bottom: 10px; font-size: 0.9rem;">
                                <i class="fas fa-eye"></i> Vista previa:
                            </div>
                            <img id="configImagenPreviewImg" 
                                 style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 2px solid var(--glass-border);">
                        </div>
                    </div>
                    
                    <!-- COLORES PERSONALIZADOS (OPCIONAL) -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-palette"></i> Color Principal del Sorteo
                        </label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="color" 
                                   id="configColorPrincipal" 
                                   value="#6366f1"
                                   style="width: 60px; height: 60px; border-radius: 10px; border: 2px solid var(--glass-border); cursor: pointer;">
                            <div>
                                <div style="color: white; font-size: 0.9rem;">Color principal</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">
                                    Afecta botones, números seleccionados y acentos
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BOTONES DE ACCIÓN -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px;">
                    <button class="btn" onclick="cargarConfiguracionActual()" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.1)); border: 1px solid rgba(99, 102, 241, 0.3); color: #a5b4fc;">
                        <i class="fas fa-sync-alt"></i> Cargar Actual
                    </button>
                    <button class="btn btn-primary" onclick="guardarConfiguracionCompleta()">
                        <i class="fas fa-save"></i> Guardar Todo
                    </button>
                </div>
                
                <!-- ESTADO DE LA CONFIGURACIÓN -->
                <div id="configCompletaStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
                
                <!-- VISTA PREVIA RÁPIDA -->
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 16px; margin-top: 25px; border: 1px solid var(--glass-border);">
                    <h4 style="color: white; margin-bottom: 15px; font-size: 1.1rem;">
                        <i class="fas fa-desktop"></i> Vista Previa
                    </h4>
                    <div id="configPreview" style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                        Los cambios se mostrarán aquí...
                    </div>
                    <button class="btn" onclick="actualizarVistaPrevia()" style="margin-top: 15px; width: 100%; background: rgba(255,255,255,0.05);">
                        <i class="fas fa-redo"></i> Actualizar Vista Previa
                    </button>
                </div>
            </div>
            
            <!-- CONFIGURACIÓN DE WHATSAPP -->
            <div class="glass-effect" style="margin-top: 20px;">
                <h3 style="color: white; margin-bottom: 20px; font-size: 1.5rem;">
                    <i class="fab fa-whatsapp"></i> Configurar WhatsApp
                </h3>
                
                <div class="config-alert">
                    <i class="fas fa-shield-alt" style="color: var(--primary); font-size: 1.2rem; margin-bottom: 10px;"></i>
                    <p><strong style="color: white; font-size: 1rem;">🔒 Protege tu número de WhatsApp</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: var(--text-secondary);">
                        Configura aquí tu número para recibir reservas. No lo compartas públicamente.
                    </p>
                </div>
                
                <div class="form-user">
                    <input type="text" 
                           id="whatsappConfig" 
                           placeholder="Ej: 573001234567 (57 + 10 dígitos)"
                           maxlength="12"
                           pattern="57\d{10}">
                    <small style="color: var(--text-secondary); font-size: 0.8rem; margin-top: -8px; margin-bottom: 15px; display: block;">
                        <strong>Formato:</strong> 57 + número de celular (10 dígitos)
                    </small>
                </div>
                
                <button class="btn btn-primary" style="width: 100%;" onclick="saveWhatsAppConfig()">
                    <i class="fas fa-save"></i> Guardar Número WhatsApp
                </button>
                
                <div id="whatsappStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--glass-border);">
                    <h4 style="color: white; margin-bottom: 10px; font-size: 1rem;">
                        <i class="fas fa-info-circle"></i> Estado actual:
                    </h4>
                    <div id="whatsappCurrent" style="color: var(--text-secondary); font-size: 0.9rem;">
                        Cargando...
                    </div>
                </div>
            </div>
            
            <!-- NOTIFICACIONES AUTOMÁTICAS -->
            <div class="glass-effect" style="margin-top: 20px;">
                <h3 style="color: white; margin-bottom: 20px; font-size: 1.5rem;">
                    <i class="fas fa-bell"></i> Notificaciones Automáticas
                </h3>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--glass-border);">
                    <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); margin-bottom: 10px;">
                        <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                        <span>Configura notificaciones automáticas para participantes</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-comment"></i> Mensaje de Confirmación de Reserva
                        </label>
                        <textarea id="notificationReserva" placeholder="Mensaje que recibirán los participantes al reservar números..."></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-money-check-alt"></i> Mensaje de Confirmación de Pago
                        </label>
                        <textarea id="notificationPago" placeholder="Mensaje que recibirán los participantes al confirmar pago..."></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-exclamation-triangle"></i> Mensaje de Recordatorio (24h antes)
                        </label>
                        <textarea id="notificationRecordatorio" placeholder="Mensaje de recordatorio para pagos pendientes..."></textarea>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="saveNotificationConfig()">
                    <i class="fas fa-save"></i> Guardar Configuración de Notificaciones
                </button>
                
                <div id="notificationStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
    <script>
        // =============================================
        // CONFIGURACIÓN COMPLETA
        // =============================================
        
        // CONFIGURACIÓN DE SEGURIDAD
        const TOTAL_NUMBERS = 1000;
        const SECURITY_CONFIG = {
            // Límites por usuario
            MAX_NUMBERS_PER_TRANSACTION: 20,
            MAX_NUMBERS_PER_USER_PER_DAY: 50,
            MAX_TRANSACTIONS_PER_HOUR: 3,
            MIN_TIME_BETWEEN_TRANSACTIONS: 60000, // 1 minuto en ms
            
            // Bloqueos
            BLOCK_DURATION: 3600000, // 1 hora en ms
            MAX_FAILED_ATTEMPTS: 5,
            
            // Validaciones
            ALLOWED_CITIES: [
                'cali', 'bogota', 'medellin', 'barranquilla', 'cartagena', 
                'bucaramanga', 'pereira', 'manizales', 'armenia', 'ibague',
                'villavicencio', 'cucuta', 'pasto', 'monteria', 'santa marta',
                'buenaventura', 'palmira', 'bello', 'soledad', 'ituango'
            ],
            
            // Formatos
            PHONE_REGEX: /^3[0-9]{9}$/, // Celular colombiano: 3 + 9 dígitos
            NAME_MIN_LENGTH: 3,
            NAME_MAX_LENGTH: 50,
            CITY_MIN_LENGTH: 2,
            
            // WhatsApp
            WHATSAPP_REGEX: /^57[0-9]{10}$/, // 57 + 10 dígitos
            WHATSAPP_COOLDOWN: 30000 // 30 segundos entre envíos
        };

        // CONFIGURACIÓN FIREBASE (REEMPLAZA CON TUS DATOS)
  const FIREBASE_CONFIG = {  
  apiKey: "AIzaSyC8j6OmhdGkyF_Jw0Fz88BG0fWuixnY-EY",
  authDomain: "sbdinamicas-2025.firebaseapp.com",
  projectId: "sbdinamicas-2025",
  storageBucket: "sbdinamicas-2025.firebasestorage.app",
  messagingSenderId: "465275725018",
  appId: "1:465275725018:web:9f58c09a23a74a419171e3"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

        // VARIABLES GLOBALES
        let WHATSAPP_NUMBER = "";
        let selected = [];
        let isFirebaseReady = false;
        let firebaseApp = null;
        let firestore = null;
        let auth = null;
        let currentUser = null;
        let lastSearchTerm = '';
        let highlightedNumbers = [];
        let selectedPaymentMethod = null;
        let currentReservationData = null;

        // BASE DE DATOS LOCAL
        window.db = JSON.parse(localStorage.getItem('sb_dinamicas_premium_db')) || {
            prize: "🎉 Sorteo Premium SB Dinámicas",
            desc: "Participa por increíbles premios en nuestro sorteo exclusivo",
            price: 20000,
            img: "",
            soldNumbers: {},
            lastSync: null,
            isAdmin: false,
            whatsappNumber: "",
            configVersion: "1.0.0",
            configCompleta: {
                fechaSorteo: null,
                piePagina: "",
                colorPrincipal: "#6366f1"
            },
            notifications: {
                reserva: "✅ Tu reserva ha sido registrada exitosamente. Números: {numeros}. Total: ${total}. Tienes 24 horas para realizar el pago.",
                pago: "🎉 ¡Pago confirmado! Tus números {numeros} están oficialmente registrados en el sorteo. ¡Buena suerte!",
                recordatorio: "⏰ Recordatorio: Tienes pendiente el pago de los números {numeros}. Total: ${total}. Realiza el pago antes de que expire tu reserva."
            }
        };

        // =============================================
        // REGISTRO DE ACTIVIDAD Y SEGURIDAD
        // =============================================
        window.securityLog = {
            failedAttempts: JSON.parse(localStorage.getItem('sb_failed_attempts')) || {},
            userActivity: JSON.parse(localStorage.getItem('sb_user_activity')) || {},
            tempBlocks: JSON.parse(localStorage.getItem('sb_temp_blocks')) || {},
            transactionLog: JSON.parse(localStorage.getItem('sb_transaction_log')) || [],
            
            save: function() {
                localStorage.setItem('sb_failed_attempts', JSON.stringify(this.failedAttempts));
                localStorage.setItem('sb_user_activity', JSON.stringify(this.userActivity));
                localStorage.setItem('sb_temp_blocks', JSON.stringify(this.tempBlocks));
                localStorage.setItem('sb_transaction_log', JSON.stringify(this.transactionLog.slice(-1000)));
            },
            
            getClientIP: function() {
                return 'browser-' + (localStorage.getItem('sb_client_id') || 
                       'id-' + Math.random().toString(36).substr(2, 9));
            },
            
            getClientId: function() {
                let clientId = localStorage.getItem('sb_client_id');
                if (!clientId) {
                    clientId = 'client-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('sb_client_id', clientId);
                }
                return clientId;
            }
        };

        // Inicializar ID de cliente
        if (!localStorage.getItem('sb_client_id')) {
            localStorage.setItem('sb_client_id', 
                'sb-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9));
        }

        // =============================================
        // INICIALIZACIÓN FIREBASE
        // =============================================
        
        function initFirebase() {
            try {
                firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
                firestore = firebase.firestore();
                auth = firebase.auth();
                
                // Configurar persistencia
                firestore.enablePersistence()
                    .then(() => {
                        console.log("Firebase persistence enabled");
                        isFirebaseReady = true;
                        updateConnectionStatus("online", "Conectado a Firebase");
                    })
                    .catch((err) => {
                        console.warn("Firebase persistence error:", err);
                        isFirebaseReady = true;
                        updateConnectionStatus("online", "Conectado (sin persistencia)");
                    });
                
                // Escuchar cambios de autenticación
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (user && window.db.isAdmin) {
                        showTab('admin-panel');
                        loadFirebaseData();
                    }
                });
                
                // Intentar cargar datos existentes
                setTimeout(loadFirebaseData, 1000);
                
            } catch (error) {
                console.error("Firebase init error:", error);
                isFirebaseReady = false;
                updateConnectionStatus("offline", "Sin conexión Firebase");
                showNotification("Usando modo offline", "warning");
            }
        }
        
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            const dotEl = statusEl.querySelector('.status-dot');
            
            if (!statusEl) return;
            
            statusEl.className = `connection-status ${status}`;
            dotEl.className = `status-dot ${status}`;
            textEl.textContent = text;
            statusEl.classList.remove('hidden');
        }
        
        function loadFirebaseData() {
            if (!isFirebaseReady || !firestore) {
                console.log("Firebase no está listo");
                return;
            }
            
            updateConnectionStatus("syncing", "Sincronizando...");
            
            // Cargar configuración
            firestore.collection('config').doc('sorteo').get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        window.db.prize = data.prize || window.db.prize;
                        window.db.desc = data.desc || window.db.desc;
                        window.db.price = data.price || window.db.price;
                        window.db.img = data.img || window.db.img;
                        window.db.configCompleta = data.configCompleta || window.db.configCompleta;
                        window.db.whatsappNumber = data.whatsappNumber || window.db.whatsappNumber;
                        window.db.notifications = data.notifications || window.db.notifications;
                        
                        save();
                        updateUI();
                        initWhatsAppNumber();
                        updateConnectionStatus("online", "Sincronizado");
                    }
                })
                .catch((error) => {
                    console.warn("Error loading config:", error);
                    updateConnectionStatus("online", "Usando datos locales");
                });
            
            // Cargar números vendidos
            firestore.collection('ventas').get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        window.db.soldNumbers[doc.id] = data;
                    });
                    save();
                    updateUI();
                    console.log("Datos cargados de Firebase:", Object.keys(window.db.soldNumbers).length, "números");
                })
                .catch((error) => {
                    console.warn("Error loading sales:", error);
                });
        }
        
        function saveToFirebase() {
            if (!isFirebaseReady || !currentUser || !firestore) {
                console.log("No se puede guardar en Firebase: no autenticado");
                return;
            }
            
            updateConnectionStatus("syncing", "Guardando en Firebase...");
            
            // Guardar configuración
            firestore.collection('config').doc('sorteo').set({
                prize: window.db.prize,
                desc: window.db.desc,
                price: window.db.price,
                img: window.db.img,
                configCompleta: window.db.configCompleta,
                whatsappNumber: window.db.whatsappNumber,
                notifications: window.db.notifications,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: currentUser.email
            })
            .then(() => {
                console.log("Configuración guardada en Firebase");
            })
            .catch((error) => {
                console.error("Error guardando configuración:", error);
            });
            
            // Guardar números vendidos
            const batch = firestore.batch();
            let count = 0;
            
            for (const [numero, data] of Object.entries(window.db.soldNumbers)) {
                if (count >= 500) break; // Límite de batch
                const docRef = firestore.collection('ventas').doc(numero);
                batch.set(docRef, data);
                count++;
            }
            
            if (count > 0) {
                batch.commit()
                    .then(() => {
                        console.log("Ventas guardadas en Firebase:", count, "registros");
                        updateConnectionStatus("online", "Datos guardados");
                        window.db.lastSync = new Date().toISOString();
                        save();
                    })
                    .catch((error) => {
                        console.error("Error guardando ventas:", error);
                        updateConnectionStatus("online", "Error guardando");
                    });
            }
        }
        
        function forceSync() {
            if (!isFirebaseReady) {
                showNotification("Firebase no está disponible", "error");
                return;
            }
            
            if (!currentUser) {
                showNotification("Debes iniciar sesión como administrador", "error");
                return;
            }
            
            saveToFirebase();
            showNotification("Sincronización iniciada", "success");
        }

        // =============================================
        // FUNCIONES DE UTILIDAD
        // =============================================
        
        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.classList.add('hidden'), 400);
            }, duration);
        }
        
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function isValidWhatsAppNumber(number) {
            return /^57\d{10}$/.test(number);
        }
        
        function formatMoney(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        function save() {
            localStorage.setItem('sb_dinamicas_premium_db', JSON.stringify(window.db));
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        // =============================================
        // FUNCIONES DE VALIDACIÓN Y SEGURIDAD
        // =============================================

        function isValidFullName(name) {
            if (!name || typeof name !== 'string') return false;
            const trimmed = name.trim();
            
            if (trimmed.length < SECURITY_CONFIG.NAME_MIN_LENGTH || 
                trimmed.length > SECURITY_CONFIG.NAME_MAX_LENGTH) {
                return false;
            }
            
            const parts = trimmed.split(' ').filter(part => part.length > 0);
            if (parts.length < 2) return false;
            
            if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s.'-]+$/.test(trimmed)) return false;
            if (/(.)\1{4,}/.test(trimmed.toLowerCase())) return false;
            
            return true;
        }

        function isValidCity(city) {
            if (!city || typeof city !== 'string') return false;
            const trimmed = city.trim();
            
            if (trimmed.length < SECURITY_CONFIG.CITY_MIN_LENGTH) return false;
            if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s.-]+$/.test(trimmed)) return false;
            
            const normalized = trimmed.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z\s]/g, "");
            
            return SECURITY_CONFIG.ALLOWED_CITIES.some(allowed => 
                normalized.includes(allowed.toLowerCase()) || 
                allowed.toLowerCase().includes(normalized)
            );
        }

        function validateAndFormatPhone(phone) {
            if (!phone || typeof phone !== 'string') return null;
            const cleaned = phone.replace(/\D/g, '');
            return SECURITY_CONFIG.PHONE_REGEX.test(cleaned) ? cleaned : null;
        }

        function validateNumberSelection(numbers) {
            const errors = [];
            
            if (!Array.isArray(numbers) || numbers.length === 0) {
                errors.push("No hay números seleccionados");
                return { isValid: false, errors };
            }
            
            if (numbers.length > SECURITY_CONFIG.MAX_NUMBERS_PER_TRANSACTION) {
                errors.push(`Máximo ${SECURITY_CONFIG.MAX_NUMBERS_PER_TRANSACTION} números por transacción`);
            }
            
            const uniqueNumbers = [...new Set(numbers)];
            if (uniqueNumbers.length !== numbers.length) {
                errors.push("Hay números duplicados en tu selección");
            }
            
            for (const num of numbers) {
                if (!/^\d{3}$/.test(num)) {
                    errors.push(`Número inválido: ${num}`);
                } else {
                    const numInt = parseInt(num);
                    if (numInt < 0 || numInt >= TOTAL_NUMBERS) {
                        errors.push(`Número fuera de rango: ${num}`);
                    }
                }
            }
            
            const unavailable = numbers.filter(n => 
                window.db.soldNumbers[n] && window.db.soldNumbers[n].pagado
            );
            
            if (unavailable.length > 0) {
                errors.push(`Números ya pagados: ${unavailable.slice(0, 5).join(', ')}${unavailable.length > 5 ? '...' : ''}`);
            }
            
            return {
                isValid: errors.length === 0,
                errors,
                cleanedNumbers: uniqueNumbers
            };
        }

        function checkUserLimits(phone, numbersCount) {
            const clientId = window.securityLog.getClientId();
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            const userKey = phone || clientId;
            
            let userActivity = window.securityLog.userActivity[userKey] || {
                transactions: [],
                numbersToday: 0,
                lastTransaction: 0,
                blockedUntil: null
            };
            
            // Verificar bloqueo
            if (userActivity.blockedUntil && now < userActivity.blockedUntil) {
                const remaining = Math.ceil((userActivity.blockedUntil - now) / 60000);
                return {
                    allowed: false,
                    reason: `Usuario bloqueado. Intenta en ${remaining} minutos`,
                    userActivity
                };
            }
            
            // Límite diario
            const todayStart = new Date().setHours(0, 0, 0, 0);
            const transactionsToday = userActivity.transactions.filter(t => 
                t.timestamp >= todayStart
            );
            const numbersToday = transactionsToday.reduce((sum, t) => sum + t.numbersCount, 0);
            
            if (numbersToday + numbersCount > SECURITY_CONFIG.MAX_NUMBERS_PER_USER_PER_DAY) {
                return {
                    allowed: false,
                    reason: `Límite diario alcanzado. Máximo ${SECURITY_CONFIG.MAX_NUMBERS_PER_USER_PER_DAY} números por día`,
                    userActivity
                };
            }
            
            // Límite por hora
            const oneHourAgo = now - 3600000;
            const recentTransactions = userActivity.transactions.filter(t => 
                t.timestamp >= oneHourAgo
            );
            
            if (recentTransactions.length >= SECURITY_CONFIG.MAX_TRANSACTIONS_PER_HOUR) {
                return {
                    allowed: false,
                    reason: `Máximo ${SECURITY_CONFIG.MAX_TRANSACTIONS_PER_HOUR} transacciones por hora`,
                    userActivity
                };
            }
            
            // Tiempo mínimo entre transacciones
            if (userActivity.lastTransaction > 0) {
                const timeSinceLast = now - userActivity.lastTransaction;
                if (timeSinceLast < SECURITY_CONFIG.MIN_TIME_BETWEEN_TRANSACTIONS) {
                    const waitSeconds = Math.ceil((SECURITY_CONFIG.MIN_TIME_BETWEEN_TRANSACTIONS - timeSinceLast) / 1000);
                    return {
                        allowed: false,
                        reason: `Espera ${waitSeconds} segundos antes de otra transacción`,
                        userActivity
                    };
                }
            }
            
            return { allowed: true, reason: "", userActivity };
        }

        function logSuccessfulTransaction(phone, numbers, action = 'reservation') {
            const clientId = window.securityLog.getClientId();
            const userKey = phone || clientId;
            const now = Date.now();
            
            let userActivity = window.securityLog.userActivity[userKey] || {
                transactions: [],
                numbersToday: 0,
                lastTransaction: 0,
                blockedUntil: null
            };
            
            userActivity.transactions.push({
                timestamp: now,
                numbers: [...numbers],
                numbersCount: numbers.length,
                action: action,
                clientId: clientId
            });
            
            if (userActivity.transactions.length > 50) {
                userActivity.transactions = userActivity.transactions.slice(-50);
            }
            
            userActivity.lastTransaction = now;
            window.securityLog.userActivity[userKey] = userActivity;
            
            window.securityLog.transactionLog.push({
                timestamp: now,
                userKey: userKey,
                numbers: numbers,
                action: action,
                ip: window.securityLog.getClientIP()
            });
            
            window.securityLog.save();
            console.log(`📝 Transacción registrada: ${action} para ${numbers.length} números`);
        }

        function logFailedAttempt(reason) {
            const ip = window.securityLog.getClientIP();
            const now = Date.now();
            
            if (!window.securityLog.failedAttempts[ip]) {
                window.securityLog.failedAttempts[ip] = {
                    count: 0,
                    firstAttempt: now,
                    lastAttempt: now,
                    reasons: []
                };
            }
            
            const attempt = window.securityLog.failedAttempts[ip];
            attempt.count++;
            attempt.lastAttempt = now;
            attempt.reasons.push({ timestamp: now, reason: reason });
            
            if (attempt.reasons.length > 20) {
                attempt.reasons = attempt.reasons.slice(-20);
            }
            
            const oneHourAgo = now - 3600000;
            const recentAttempts = attempt.reasons.filter(r => r.timestamp >= oneHourAgo);
            
            if (recentAttempts.length >= SECURITY_CONFIG.MAX_FAILED_ATTEMPTS) {
                const blockKey = `block-${ip}`;
                window.securityLog.tempBlocks[blockKey] = now + SECURITY_CONFIG.BLOCK_DURATION;
                console.warn(`🚫 IP bloqueada: ${ip} por demasiados intentos fallidos`);
                showNotification(`Demasiados intentos fallidos. IP bloqueada por 1 hora.`, "error", 5000);
            }
            
            window.securityLog.save();
            return attempt.count;
        }

        function isClientBlocked() {
            const ip = window.securityLog.getClientIP();
            const blockKey = `block-${ip}`;
            
            if (window.securityLog.tempBlocks[blockKey]) {
                const blockUntil = window.securityLog.tempBlocks[blockKey];
                const now = Date.now();
                
                if (now < blockUntil) {
                    const remainingMinutes = Math.ceil((blockUntil - now) / 60000);
                    return {
                        blocked: true,
                        remainingMinutes: remainingMinutes,
                        message: `IP bloqueada. Intenta en ${remainingMinutes} minutos`
                    };
                } else {
                    delete window.securityLog.tempBlocks[blockKey];
                    window.securityLog.save();
                }
            }
            
            return { blocked: false };
        }

        function cleanupExpiredBlocks() {
            const now = Date.now();
            let cleaned = false;
            
            for (const [key, expires] of Object.entries(window.securityLog.tempBlocks)) {
                if (now >= expires) {
                    delete window.securityLog.tempBlocks[key];
                    cleaned = true;
                }
            }
            
            const oneDayAgo = now - 24 * 60 * 60 * 1000;
            for (const [ip, data] of Object.entries(window.securityLog.failedAttempts)) {
                if (data.lastAttempt < oneDayAgo) {
                    delete window.securityLog.failedAttempts[ip];
                    cleaned = true;
                }
            }
            
            if (cleaned) window.securityLog.save();
            return cleaned;
        }

        function validateCompleteReservation(nombre, ciudad, celular, numeros) {
            const errors = [];
            const warnings = [];
            
            // 1. Verificar bloqueos
            const blockCheck = isClientBlocked();
            if (blockCheck.blocked) {
                errors.push(blockCheck.message);
                return { isValid: false, errors, warnings, celularFormateado: null };
            }
            
            // 2. Validar nombre
            if (!isValidFullName(nombre)) {
                errors.push("Nombre inválido. Debe tener nombre y apellido, solo letras");
            }
            
            // 3. Validar ciudad
            if (!isValidCity(ciudad)) {
                errors.push(`Ciudad no permitida. Ciudades válidas: ${SECURITY_CONFIG.ALLOWED_CITIES.slice(0, 5).join(', ')}...`);
            }
            
            // 4. Validar celular
            const celularFormateado = validateAndFormatPhone(celular);
            if (!celularFormateado) {
                errors.push("Celular inválido. Debe comenzar con 3 y tener 10 dígitos");
            }
            
            // 5. Validar números
            const numberValidation = validateNumberSelection(numeros);
            if (!numberValidation.isValid) {
                errors.push(...numberValidation.errors);
            }
            
            // 6. Verificar límites del usuario
            if (celularFormateado && numberValidation.cleanedNumbers) {
                const limitCheck = checkUserLimits(
                    celularFormateado, 
                    numberValidation.cleanedNumbers.length
                );
                
                if (!limitCheck.allowed) {
                    errors.push(limitCheck.reason);
                }
            }
            
            // 7. Verificar disponibilidad real
            if (numberValidation.cleanedNumbers) {
                const realmenteDisponibles = numberValidation.cleanedNumbers.filter(n => {
                    const sold = window.db.soldNumbers[n];
                    return !sold || (sold && !sold.pagado && sold.celular !== celularFormateado);
                });
                
                if (realmenteDisponibles.length !== numberValidation.cleanedNumbers.length) {
                    const noDisponibles = numberValidation.cleanedNumbers.filter(n => 
                        !realmenteDisponibles.includes(n)
                    );
                    
                    warnings.push(`Algunos números pueden no estar disponibles: ${noDisponibles.slice(0, 3).join(', ')}${noDisponibles.length > 3 ? '...' : ''}`);
                }
            }
            
            // Si hay errores, registrar intento fallido
            if (errors.length > 0) {
                const attemptCount = logFailedAttempt(errors.join('; '));
                if (attemptCount >= 3) {
                    warnings.push(`⚠️ Has tenido ${attemptCount} intentos fallidos. Demasiados intentos pueden bloquear tu IP.`);
                }
            }
            
            return {
                isValid: errors.length === 0,
                errors,
                warnings,
                celularFormateado,
                numerosLimpios: numberValidation.cleanedNumbers || [],
                timestamp: Date.now()
            };
        }

        // =============================================
        // VALIDACIÓN DE CAMPOS EN TIEMPO REAL
        // =============================================
        
        function validateField(input, type) {
            const value = input.value.trim();
            const validationId = input.id.replace('u', '') + 'Validation';
            const validationEl = document.getElementById(validationId);
            
            if (!validationEl) return;
            
            let isValid = false;
            let message = "";
            
            switch(type) {
                case 'name':
                    isValid = isValidFullName(value);
                    message = isValid ? "✓ Nombre válido" : "✗ Debe tener nombre y apellido (solo letras)";
                    break;
                case 'city':
                    isValid = isValidCity(value);
                    message = isValid ? "✓ Ciudad válida" : "✗ Ciudad no permitida o formato incorrecto";
                    break;
                case 'phone':
                    const formatted = validateAndFormatPhone(value);
                    isValid = formatted !== null;
                    message = isValid ? "✓ Celular válido" : "✗ Debe ser celular colombiano (10 dígitos, comienza con 3)";
                    break;
            }
            
            input.classList.remove('input-valid', 'input-invalid');
            validationEl.classList.remove('validation-success', 'validation-error');
            
            if (value === "") {
                validationEl.style.display = 'none';
                return;
            }
            
            if (isValid) {
                input.classList.add('input-valid');
                validationEl.textContent = message;
                validationEl.classList.add('validation-success');
                validationEl.style.display = 'block';
            } else {
                input.classList.add('input-invalid');
                validationEl.textContent = message;
                validationEl.classList.add('validation-error');
                validationEl.style.display = 'block';
            }
        }

        // =============================================
        // FUNCIONES DE WHATSAPP
        // =============================================
        
        function initWhatsAppNumber() {
            if (window.db.whatsappNumber && isValidWhatsAppNumber(window.db.whatsappNumber)) {
                WHATSAPP_NUMBER = window.db.whatsappNumber;
                updateWhatsAppStatus();
                hideWhatsAppAlert();
                return true;
            }
            
            const savedNumber = localStorage.getItem('sb_whatsapp_number');
            if (savedNumber && isValidWhatsAppNumber(savedNumber)) {
                WHATSAPP_NUMBER = savedNumber;
                window.db.whatsappNumber = savedNumber;
                save();
                updateWhatsAppStatus();
                hideWhatsAppAlert();
                return true;
            }
            
            showWhatsAppAlert();
            WHATSAPP_NUMBER = "";
            updateWhatsAppStatus();
            return false;
        }
        
        function updateWhatsAppStatus() {
            const statusEl = document.getElementById('whatsappCurrent');
            if (!statusEl) return;
            
            if (WHATSAPP_NUMBER) {
                const formatted = WHATSAPP_NUMBER.replace(/^57/, '+57 ');
                statusEl.innerHTML = `
                    <div style="color: var(--success);">
                        <i class="fas fa-check-circle"></i> Configurado correctamente
                    </div>
                    <div style="margin-top: 5px; font-size: 0.85rem;">
                        Número: <strong>${formatted}</strong>
                    </div>
                `;
            } else {
                statusEl.innerHTML = `
                    <div style="color: var(--accent);">
                        <i class="fas fa-exclamation-triangle"></i> No configurado
                    </div>
                    <div style="margin-top: 5px; font-size: 0.85rem;">
                        Configura un número para recibir reservas
                    </div>
                `;
            }
        }
        
        function showWhatsAppAlert() {
            const alertEl = document.getElementById('whatsappAlert');
            if (alertEl) alertEl.classList.remove('hidden');
        }
        
        function hideWhatsAppAlert() {
            const alertEl = document.getElementById('whatsappAlert');
            if (alertEl) alertEl.classList.add('hidden');
        }
        
        function saveWhatsAppConfig() {
            const numberInput = document.getElementById('whatsappConfig').value.trim();
            const statusEl = document.getElementById('whatsappStatus');
            
            if (!isValidWhatsAppNumber(numberInput)) {
                showStatus(statusEl, "❌ Formato inválido. Usa: 57 + 10 dígitos", "error");
                return;
            }
            
            WHATSAPP_NUMBER = numberInput;
            localStorage.setItem('sb_whatsapp_number', numberInput);
            window.db.whatsappNumber = numberInput;
            save();
            
            // Guardar en Firebase si está disponible
            if (isFirebaseReady && currentUser) {
                saveToFirebase();
            }
            
            hideWhatsAppAlert();
            showStatus(statusEl, "✅ WhatsApp configurado exitosamente", "success");
            updateWhatsAppStatus();
            showNotification("Número de WhatsApp actualizado", "success");
        }
        
        function showStatus(element, message, type) {
            if (!element) return;
            
            element.textContent = message;
            element.style.display = 'block';
            element.style.background = type === 'success' 
                ? 'rgba(34, 197, 94, 0.1)' 
                : 'rgba(244, 63, 94, 0.1)';
            element.style.border = type === 'success' 
                ? '1px solid rgba(34, 197, 94, 0.3)' 
                : '1px solid rgba(244, 63, 94, 0.3)';
            element.style.color = type === 'success' ? '#22c55e' : '#f43f5e';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // =============================================
        // FUNCIONES DE CONFIGURACIÓN COMPLETA
        // =============================================
        
        function cargarConfiguracionActual() {
            console.log("Cargando configuración actual...");
            
            document.getElementById('configTitulo').value = window.db.prize || "";
            document.getElementById('configDescripcion').value = window.db.desc || "";
            document.getElementById('configValor').value = window.db.price || 20000;
            
            if (window.db.configCompleta) {
                const config = window.db.configCompleta;
                document.getElementById('configFecha').value = config.fechaSorteo || "";
                document.getElementById('configPiePagina').value = config.piePagina || "";
                document.getElementById('configColorPrincipal').value = config.colorPrincipal || "#6366f1";
            } else {
                const fechaPredeterminada = new Date();
                fechaPredeterminada.setDate(fechaPredeterminada.getDate() + 30);
                document.getElementById('configFecha').value = fechaPredeterminada.toISOString().slice(0, 16);
                document.getElementById('configPiePagina').value = "• El sorteo se realizará de forma transparente y será transmitido en vivo.\n• Los ganadores serán notificados por WhatsApp.\n• Para reclamar premios mayores a $500,000 se requiere identificación.";
            }
            
            // Cargar notificaciones
            if (window.db.notifications) {
                document.getElementById('notificationReserva').value = window.db.notifications.reserva || "";
                document.getElementById('notificationPago').value = window.db.notifications.pago || "";
                document.getElementById('notificationRecordatorio').value = window.db.notifications.recordatorio || "";
            }
            
            if (window.db.img) {
                const previewImg = document.getElementById('configImagenPreviewImg');
                previewImg.src = window.db.img;
                document.getElementById('configImagenPreview').style.display = 'block';
            }
            
            actualizarVistaPrevia();
            showNotification("Configuración actual cargada", "success");
        }
        
        function uploadConfigImage(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification("La imagen no debe superar 5MB", "error");
                return;
            }
            
            if (!file.type.match('image.*')) {
                showNotification("Solo se permiten imágenes", "error");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => { 
                window.db.img = e.target.result;
                const previewImg = document.getElementById('configImagenPreviewImg');
                previewImg.src = e.target.result;
                document.getElementById('configImagenPreview').style.display = 'block';
                actualizarVistaPrevia();
                showNotification("Imagen cargada exitosamente", "success");
            };
            reader.onerror = () => {
                showNotification("Error al cargar la imagen", "error");
            };
            reader.readAsDataURL(file);
        }
        
        function guardarConfiguracionCompleta() {
            const titulo = document.getElementById('configTitulo').value.trim();
            const descripcion = document.getElementById('configDescripcion').value.trim();
            const valor = parseInt(document.getElementById('configValor').value);
            const fecha = document.getElementById('configFecha').value;
            const piePagina = document.getElementById('configPiePagina').value.trim();
            const colorPrincipal = document.getElementById('configColorPrincipal').value;
            
            const statusEl = document.getElementById('configCompletaStatus');
            
            if (!titulo || titulo.length < 5) {
                showStatus(statusEl, "❌ El título debe tener al menos 5 caracteres", "error");
                return;
            }
            
            if (!descripcion || descripcion.length < 10) {
                showStatus(statusEl, "❌ La descripción debe tener al menos 10 caracteres", "error");
                return;
            }
            
            if (!valor || valor < 1000) {
                showStatus(statusEl, "❌ El valor debe ser mínimo $1,000 COP", "error");
                return;
            }
            
            if (!fecha) {
                showStatus(statusEl, "❌ Selecciona una fecha para el sorteo", "error");
                return;
            }
            
            window.db.prize = escapeHTML(titulo);
            window.db.desc = escapeHTML(descripcion);
            window.db.price = valor;
            
            window.db.configCompleta = {
                fechaSorteo: fecha,
                piePagina: escapeHTML(piePagina),
                colorPrincipal: colorPrincipal,
                ultimaActualizacion: new Date().toISOString()
            };
            
            if (colorPrincipal && colorPrincipal !== "#6366f1") {
                aplicarColorPersonalizado(colorPrincipal);
            }
            
            save();
            
            // Guardar en Firebase si está disponible
            if (isFirebaseReady && currentUser) {
                saveToFirebase();
            }
            
            showStatus(statusEl, "✅ Configuración completa guardada exitosamente", "success");
            showNotification("Configuración del sorteo actualizada", "success");
            actualizarVistaPrevia();
            updateUI();
            
            setTimeout(() => {
                showTab('admin-panel');
            }, 1500);
        }
        
        function aplicarColorPersonalizado(color) {
            document.documentElement.style.setProperty('--primary', color);
            const colorOscuro = oscurecerColor(color, 20);
            document.documentElement.style.setProperty('--primary-dark', colorOscuro);
            document.documentElement.style.setProperty('--color-seleccionado', color);
            console.log("Color personalizado aplicado:", color);
        }
        
        function oscurecerColor(color, porcentaje) {
            let r = parseInt(color.substr(1, 2), 16);
            let g = parseInt(color.substr(3, 2), 16);
            let b = parseInt(color.substr(5, 2), 16);
            
            r = Math.floor(r * (100 - porcentaje) / 100);
            g = Math.floor(g * (100 - porcentaje) / 100);
            b = Math.floor(b * (100 - porcentaje) / 100);
            
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        
        function actualizarVistaPrevia() {
            const titulo = document.getElementById('configTitulo').value || "[Sin título]";
            const descripcion = document.getElementById('configDescripcion').value || "[Sin descripción]";
            const valor = document.getElementById('configValor').value || "0";
            const fecha = document.getElementById('configFecha').value;
            const piePagina = document.getElementById('configPiePagina').value || "[Sin información adicional]";
            
            let fechaFormateada = "No configurada";
            if (fecha) {
                const fechaObj = new Date(fecha);
                fechaFormateada = fechaObj.toLocaleDateString('es-CO', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            const previewHTML = `
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <div style="font-size: 1.4rem; font-weight: 800; color: white; margin-bottom: 10px;">
                        ${escapeHTML(titulo)}
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: 15px; line-height: 1.5;">
                        ${escapeHTML(descripcion.replace(/\n/g, '<br>'))}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: var(--warning); font-size: 0.9rem;">Valor por boleto:</div>
                            <div style="font-size: 1.8rem; font-weight: 800; color: white;">
                                $${parseInt(valor).toLocaleString('es-CO')} COP
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--primary); font-size: 0.9rem;">
                                <i class="fas fa-calendar-alt"></i> ${fechaFormateada}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.4;">
                        ${escapeHTML(piePagina.replace(/\n/g, '<br>'))}
                    </div>
                </div>
                
                ${window.db.img ? `
                <div style="margin-top: 15px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">Imagen del premio:</div>
                    <img src="${window.db.img}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid var(--glass-border);">
                </div>
                ` : ''}
                
                <div style="margin-top: 15px; font-size: 0.75rem; color: var(--text-secondary);">
                    <i class="fas fa-info-circle"></i> Esta es una vista previa de cómo verán los participantes el sorteo.
                </div>
            `;
            
            document.getElementById('configPreview').innerHTML = previewHTML;
        }
        
        function actualizarContadorSorteo() {
            if (window.db.configCompleta && window.db.configCompleta.fechaSorteo) {
                const fechaSorteo = new Date(window.db.configCompleta.fechaSorteo);
                const ahora = new Date();
                const diferenciaMs = fechaSorteo - ahora;
                
                if (diferenciaMs > 0) {
                    const dias = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24));
                    const horas = Math.floor((diferenciaMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    
                    let contadorEl = document.getElementById('contadorSorteo');
                    if (!contadorEl) {
                        const panelPremio = document.querySelector('#view-user .glass-effect');
                        if (panelPremio) {
                            contadorEl = document.createElement('div');
                            contadorEl.id = 'contadorSorteo';
                            contadorEl.style.marginTop = '15px';
                            contadorEl.style.padding = '15px';
                            contadorEl.style.background = 'rgba(99, 102, 241, 0.1)';
                            contadorEl.style.borderRadius = '12px';
                            contadorEl.style.border = '1px solid rgba(99, 102, 241, 0.2)';
                            contadorEl.style.textAlign = 'center';
                            panelPremio.appendChild(contadorEl);
                        }
                    }
                    
                    if (contadorEl) {
                        contadorEl.innerHTML = `
                            <div style="color: var(--primary); font-weight: 600; margin-bottom: 5px;">
                                <i class="fas fa-clock"></i> SORTEO EN:
                            </div>
                            <div style="font-size: 1.8rem; font-weight: 800; color: white;">
                                ${dias} DÍAS ${horas} HRS
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">
                                ${fechaSorteo.toLocaleDateString('es-CO', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                        `;
                    }
                }
            }
        }
        
        function saveNotificationConfig() {
            const reserva = document.getElementById('notificationReserva').value.trim();
            const pago = document.getElementById('notificationPago').value.trim();
            const recordatorio = document.getElementById('notificationRecordatorio').value.trim();
            
            const statusEl = document.getElementById('notificationStatus');
            
            if (!reserva || !pago || !recordatorio) {
                showStatus(statusEl, "❌ Todos los campos de notificación son requeridos", "error");
                return;
            }
            
            window.db.notifications = {
                reserva: reserva,
                pago: pago,
                recordatorio: recordatorio
            };
            
            save();
            
            // Guardar en Firebase si está disponible
            if (isFirebaseReady && currentUser) {
                saveToFirebase();
            }
            
            showStatus(statusEl, "✅ Configuración de notificaciones guardada", "success");
            showNotification("Notificaciones configuradas", "success");
        }

        // =============================================
        // FUNCIONES PRINCIPALES DE LA APLICACIÓN
        // =============================================
        
        function showTab(tab) {
            const views = ['user', 'admin-login', 'admin-panel', 'admin-config'];
            views.forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (el) {
                    el.classList.add('hidden');
                    if (v !== 'user') el.classList.remove('fade-in');
                }
            });
            
            const target = document.getElementById(`view-${tab}`);
            if (target) {
                target.classList.remove('hidden');
                if (tab !== 'user') target.classList.add('fade-in');
            }
            
            if (tab === 'admin-config' && window.db.isAdmin) {
                cargarConfiguracionActual();
            }
            
            if (tab === 'user') {
                clearSearch();
            }
            
            updateUI();
        }
        
        function updateUI() {
            // Actualizar información del sorteo
            document.getElementById('displayPrizeTitle').textContent = window.db.prize;
            document.getElementById('displayPrizeDesc').textContent = window.db.desc;
            document.getElementById('displayPrice').textContent = window.db.price.toLocaleString('es-CO');
            
            // Mostrar/ocultar imagen
            const imgContainer = document.getElementById('prizeImageContainer');
            const imgElement = document.getElementById('displayPrizeImg');
            if (window.db.img && window.db.img.trim() !== '') {
                imgElement.src = window.db.img;
                imgContainer.style.display = 'block';
            } else {
                imgContainer.style.display = 'none';
            }
            
            // Actualizar contador
            actualizarContadorSorteo();
            
            // Actualizar grid de números
            initGrid();
            
            // Actualizar panel admin si está visible
            if (document.getElementById('view-admin-panel') && !document.getElementById('view-admin-panel').classList.contains('hidden')) {
                updateAdminPanel();
            }
        }
        
        function initGrid() {
            const grid = document.getElementById('mainGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            for(let i = 0; i < TOTAL_NUMBERS; i++) {
                const n = i.toString().padStart(3, '0');
                const div = document.createElement('div');
                
                let estado = '';
                if(window.db.soldNumbers[n]) {
                    estado = window.db.soldNumbers[n].pagado ? ' pagado' : ' apartado';
                }
                
                const isSelected = selected.includes(n);
                const isHighlighted = highlightedNumbers.includes(n);
                
                div.className = 'number-item' + estado + (isSelected ? ' selected' : '') + (isHighlighted ? ' highlighted' : '');
                div.id = `num-${n}`;
                div.textContent = n;
                div.onclick = () => toggleNumber(n);
                
                // Agregar badge si está apartado
                if (window.db.soldNumbers[n] && !window.db.soldNumbers[n].pagado) {
                    const badge = document.createElement('span');
                    badge.className = 'number-badge';
                    badge.textContent = 'A';
                    div.appendChild(badge);
                }
                
                grid.appendChild(div);
            }
            
            updateSelectionSummary();
        }
        
        function toggleNumber(num) {
            const index = selected.indexOf(num);
            const element = document.getElementById(`num-${num}`);
            
            // Si el número ya está pagado, no hacer nada
            if (window.db.soldNumbers[num] && window.db.soldNumbers[num].pagado) {
                showNotification("Este número ya está pagado", "warning");
                return;
            }
            
            // Si está apartado por otro usuario, no hacer nada
            if (window.db.soldNumbers[num] && !window.db.soldNumbers[num].pagado) {
                showNotification("Este número está apartado", "warning");
                return;
            }
            
            if (index === -1) {
                // Agregar si no está seleccionado y hay espacio
                if (selected.length >= SECURITY_CONFIG.MAX_NUMBERS_PER_TRANSACTION) {
                    showNotification(`Máximo ${SECURITY_CONFIG.MAX_NUMBERS_PER_TRANSACTION} números por transacción`, "warning");
                    return;
                }
                selected.push(num);
                element.classList.add('selected');
            } else {
                // Remover si ya está seleccionado
                selected.splice(index, 1);
                element.classList.remove('selected');
            }
            
            updateSelectionSummary();
        }
        
        function updateSelectionSummary() {
            const summaryEl = document.getElementById('selectionSummary');
            const badgeEl = document.getElementById('selectedCountBadge');
            
            if (selected.length === 0) {
                summaryEl.innerHTML = `
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> Selecciona tus números
                    </div>
                `;
                badgeEl.style.display = 'none';
            } else {
                const total = selected.length * window.db.price;
                summaryEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="color: white; font-weight: 600; font-size: 1.1rem;">
                                ${selected.length} número${selected.length !== 1 ? 's' : ''} seleccionado${selected.length !== 1 ? 's' : ''}
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                ${selected.sort().join(', ')}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--warning); font-size: 0.9rem;">Total:</div>
                            <div style="color: white; font-weight: 800; font-size: 1.3rem;">
                                $${total.toLocaleString('es-CO')}
                            </div>
                        </div>
                    </div>
                `;
                badgeEl.textContent = selected.length;
                badgeEl.style.display = 'inline-block';
            }
        }
        
        function selectRandom(count) {
            if (selected.length >= SECURITY_CONFIG.MAX_NUMBERS_PER_TRANSACTION) {
                showNotification(`Máximo ${SECURITY_CONFIG.MAX_NUMBERS_PER_TRANSACTION} números por transacción`, "warning");
                return;
            }
            
            const disponibles = [];
            for(let i = 0; i < TOTAL_NUMBERS; i++) {
                const n = i.toString().padStart(3, '0');
                if (!selected.includes(n) && 
                    (!window.db.soldNumbers[n] || 
                     (window.db.soldNumbers[n] && window.db.soldNumbers[n].pagado === false))) {
                    disponibles.push(n);
                }
            }
            
            if (disponibles.length === 0) {
                showNotification("No hay números disponibles", "warning");
                return;
            }
            
            const remainingSlots = SECURITY_CONFIG.MAX_NUMBERS_PER_TRANSACTION - selected.length;
            const toSelect = Math.min(count, remainingSlots, disponibles.length);
            
            // Mezclar array
            for (let i = disponibles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [disponibles[i], disponibles[j]] = [disponibles[j], disponibles[i]];
            }
            
            // Seleccionar los primeros 'toSelect'
            const nuevos = disponibles.slice(0, toSelect);
            nuevos.forEach(n => {
                if (!selected.includes(n)) {
                    selected.push(n);
                    const element = document.getElementById(`num-${n}`);
                    if (element) element.classList.add('selected');
                }
            });
            
            updateSelectionSummary();
            showNotification(`${toSelect} números seleccionados aleatoriamente`, "success");
        }
        
        function clearSelection() {
            selected.forEach(n => {
                const element = document.getElementById(`num-${n}`);
                if (element) element.classList.remove('selected');
            });
            selected = [];
            updateSelectionSummary();
            showNotification("Selección limpiada", "info");
        }
        
        function searchNumbers() {
            const searchTerm = document.getElementById('numberSearch').value.trim();
            const resultsInfo = document.getElementById('searchResultsInfo');
            
            if (!searchTerm) {
                clearSearch();
                return;
            }
            
            if (!/^\d{1,3}$/.test(searchTerm)) {
                resultsInfo.innerHTML = "Ingresa solo números (1-3 dígitos)";
                resultsInfo.classList.remove('hidden');
                return;
            }
            
            lastSearchTerm = searchTerm;
            highlightedNumbers = [];
            let count = 0;
            
            for (let i = 0; i < TOTAL_NUMBERS; i++) {
                const num = i.toString().padStart(3, '0');
                const element = document.getElementById(`num-${num}`);
                
                if (element) {
                    if (num.includes(searchTerm)) {
                        element.classList.add('highlighted');
                        highlightedNumbers.push(num);
                        count++;
                        
                        if (count === 1) {
                            setTimeout(() => {
                                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 150);
                        }
                    } else {
                        element.classList.remove('highlighted');
                    }
                }
            }
            
            if (count > 0) {
                resultsInfo.innerHTML = `🔍 Encontrados ${count} número(s) que contienen "${searchTerm}"`;
                resultsInfo.classList.remove('hidden');
            } else {
                resultsInfo.innerHTML = `❌ No se encontraron números que contengan "${searchTerm}"`;
                resultsInfo.classList.remove('hidden');
            }
        }
        
        function clearSearch() {
            document.getElementById('numberSearch').value = '';
            lastSearchTerm = '';
            highlightedNumbers.forEach(num => {
                const element = document.getElementById(`num-${num}`);
                if (element) element.classList.remove('highlighted');
            });
            highlightedNumbers = [];
            document.getElementById('searchResultsInfo').classList.add('hidden');
            initGrid();
        }
        
        function validateAndReserve() {
            // Obtener datos del formulario
            const nombre = document.getElementById('uNombre').value.trim();
            const ciudad = document.getElementById('uCiudad').value.trim();
            const celular = document.getElementById('uCelular').value.trim();
            
            // Validación completa
            const validation = validateCompleteReservation(nombre, ciudad, celular, selected);
            
            if (!validation.isValid) {
                // Mostrar errores
                let errorMessage = "Errores encontrados:\n";
                validation.errors.forEach((error, index) => {
                    errorMessage += `${index + 1}. ${error}\n`;
                });
                
                if (validation.warnings.length > 0) {
                    errorMessage += "\nAdvertencias:\n";
                    validation.warnings.forEach((warning, index) => {
                        errorMessage += `${index + 1}. ${warning}\n`;
                    });
                }
                
                showNotification(errorMessage, "error", 6000);
                return;
            }
            
            // Mostrar advertencias si las hay
            if (validation.warnings.length > 0) {
                let warningMessage = "Advertencias:\n";
                validation.warnings.forEach((warning, index) => {
                    warningMessage += `${index + 1}. ${warning}\n`;
                });
                showNotification(warningMessage, "warning", 5000);
            }
            
            // Guardar datos para la reserva
            currentReservationData = {
                nombre: nombre,
                ciudad: ciudad,
                celular: validation.celularFormateado,
                numeros: validation.numerosLimpios,
                total: validation.numerosLimpios.length * window.db.price,
                timestamp: validation.timestamp
            };
            
            // Verificar WhatsApp configurado
            if (!WHATSAPP_NUMBER) {
                showNotification("WhatsApp no configurado. Contacta al administrador.", "error");
                return;
            }
            
            // Mostrar modal de confirmación de WhatsApp
            showWhatsAppConfirmation();
        }
        
        function showWhatsAppConfirmation() {
            if (!currentReservationData) return;
            
            const detailsEl = document.getElementById('whatsappDetails');
            const numerosStr = currentReservationData.numeros.join(', ');
            
            detailsEl.innerHTML = `
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <div style="color: white; margin-bottom: 10px; font-weight: 600;">Resumen de tu reserva:</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">
                        <strong>Nombre:</strong> ${currentReservationData.nombre}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">
                        <strong>Números:</strong> ${numerosStr}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">
                        <strong>Total:</strong> $${currentReservationData.total.toLocaleString('es-CO')}
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        <strong>Celular:</strong> ${currentReservationData.celular}
                    </div>
                </div>
                <div style="color: var(--text-secondary); font-size: 0.85rem; text-align: center;">
                    Se abrirá WhatsApp para confirmar tu reserva
                </div>
            `;
            
            openModal('whatsappConfirmationModal');
        }
        
        function sendWhatsAppReservation() {
            if (!currentReservationData || !WHATSAPP_NUMBER) {
                showNotification("Error en los datos de reserva", "error");
                return;
            }
            
            const numerosStr = currentReservationData.numeros.join(', ');
            const totalFormatted = currentReservationData.total.toLocaleString('es-CO');
            
            // Crear mensaje de WhatsApp
            let mensaje = `Hola, quiero reservar los siguientes números para el sorteo:\n\n`;
            mensaje += `*Nombre:* ${currentReservationData.nombre}\n`;
            mensaje += `*Ciudad:* ${currentReservationData.ciudad}\n`;
            mensaje += `*Celular:* ${currentReservationData.celular}\n`;
            mensaje += `*Números:* ${numerosStr}\n`;
            mensaje += `*Total:* $${totalFormatted}\n\n`;
            mensaje += `Por favor confírmame la disponibilidad y los datos para el pago.`;
            
            // Codificar mensaje para URL
            const mensajeCodificado = encodeURIComponent(mensaje);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${mensajeCodificado}`;
            
            // Registrar transacción exitosa
            logSuccessfulTransaction(
                currentReservationData.celular, 
                currentReservationData.numeros, 
                'whatsapp_reservation'
            );
            
            // Abrir WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Cerrar modal
            closeModal('whatsappConfirmationModal');
            
            // Mostrar confirmación
            showNotification("WhatsApp abierto. Completa la reserva enviando el mensaje.", "success", 5000);
            
            // Limpiar selección
            clearSelection();
            
            // Limpiar formulario
            document.getElementById('uNombre').value = '';
            document.getElementById('uCiudad').value = '';
            document.getElementById('uCelular').value = '';
            
            // Limpiar datos de reserva
            currentReservationData = null;
        }
        
        function showPaymentOptions() {
            if (!currentReservationData) {
                showNotification("Primero debes completar tus datos y seleccionar números", "warning");
                return;
            }
            
            const summaryEl = document.getElementById('paymentSummary');
            const numerosStr = currentReservationData.numeros.join(', ');
            
            summaryEl.innerHTML = `
                <div style="color: white; margin-bottom: 8px; font-weight: 600;">Detalles:</div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">
                    <strong>Números:</strong> ${numerosStr}
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">
                    <strong>Cantidad:</strong> ${currentReservationData.numeros.length} números
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">
                    <strong>Valor unitario:</strong> $${window.db.price.toLocaleString('es-CO')}
                </div>
                <div style="color: var(--success); font-size: 1.1rem; font-weight: 800; margin-top: 10px;">
                    TOTAL: $${currentReservationData.total.toLocaleString('es-CO')}
                </div>
            `;
            
            selectedPaymentMethod = null;
            document.getElementById('paymentDetails').style.display = 'none';
            openModal('paymentModal');
        }
        
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Remover selección de todos los métodos
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Agregar selección al método clickeado
            event.currentTarget.classList.add('selected');
            
            // Mostrar detalles del método seleccionado
            const detailsEl = document.getElementById('paymentDetails');
            const titleEl = document.getElementById('paymentMethodTitle');
            const instructionsEl = document.getElementById('paymentInstructions');
            
            detailsEl.style.display = 'block';
            
            let title = '';
            let instructions = '';
            
            switch(method) {
                case 'transfer':
                    title = 'Transferencia Bancaria';
                    instructions = `
                        <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                            <p><strong>Banco:</strong> Bancolombia</p>
                            <p><strong>Titular:</strong> SB DINÁMICAS S.A.S.</p>
                            <p><strong>Cuenta:</strong> 123-456789-12</p>
                            <p><strong>Tipo:</strong> Cuenta de Ahorros</p>
                            <p style="margin-top: 10px; color: var(--warning);">
                                <i class="fas fa-exclamation-circle"></i> 
                                Envíanos el comprobante por WhatsApp al finalizar.
                            </p>
                        </div>
                    `;
                    break;
                    
                case 'nequi':
                    title = 'Nequi';
                    instructions = `
                        <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                            <p><strong>Número:</strong> 300 123 4567</p>
                            <p><strong>Nombre:</strong> SB DINÁMICAS</p>
                            <p style="margin-top: 10px; color: var(--warning);">
                                <i class="fas fa-exclamation-circle"></i> 
                                Envíanos el comprobante por WhatsApp al finalizar.
                            </p>
                        </div>
                    `;
                    break;
                    
                case 'daviplata':
                    title = 'DaviPlata';
                    instructions = `
                        <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                            <p><strong>Número:</strong> 300 123 4567</p>
                            <p><strong>Nombre:</strong> SB DINÁMICAS</p>
                            <p style="margin-top: 10px; color: var(--warning);">
                                <i class="fas fa-exclamation-circle"></i> 
                                Envíanos el comprobante por WhatsApp al finalizar.
                            </p>
                        </div>
                    `;
                    break;
                    
                case 'efecty':
                    title = 'Efecty';
                    instructions = `
                        <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                            <p><strong>Documento:</strong> 123456789</p>
                            <p><strong>Nombre:</strong> SB DINÁMICAS</p>
                            <p><strong>Referencia:</strong> SORTEO-${Date.now().toString().slice(-6)}</p>
                            <p style="margin-top: 10px; color: var(--warning);">
                                <i class="fas fa-exclamation-circle"></i> 
                                Guarda el recibo y envíanos la foto por WhatsApp.
                            </p>
                        </div>
                    `;
                    break;
            }
            
            titleEl.textContent = title;
            instructionsEl.innerHTML = instructions;
        }
        
        function confirmPayment() {
            if (!selectedPaymentMethod) {
                showNotification("Selecciona un método de pago", "warning");
                return;
            }
            
            if (!currentReservationData) {
                showNotification("Error en los datos de reserva", "error");
                return;
            }
            
            // Marcar números como apartados en la base de datos
            const timestamp = Date.now();
            const reservationId = 'reserva-' + timestamp;
            
            currentReservationData.numeros.forEach(num => {
                window.db.soldNumbers[num] = {
                    nombre: currentReservationData.nombre,
                    ciudad: currentReservationData.ciudad,
                    celular: currentReservationData.celular,
                    numeros: currentReservationData.numeros,
                    total: currentReservationData.total,
                    pagado: false,
                    metodo: selectedPaymentMethod,
                    timestamp: timestamp,
                    reservaId: reservationId,
                    expira: timestamp + (24 * 60 * 60 * 1000) // 24 horas
                };
            });
            
            // Guardar cambios
            save();
            
            // Registrar transacción
            logSuccessfulTransaction(
                currentReservationData.celular,
                currentReservationData.numeros,
                'payment_initiated'
            );
            
            // Sincronizar con Firebase si está disponible
            if (isFirebaseReady) {
                saveToFirebase();
            }
            
            // Cerrar modal
            closeModal('paymentModal');
            
            // Mostrar confirmación
            showNotification(
                `Reserva confirmada por $${currentReservationData.total.toLocaleString('es-CO')}. ` +
                `Tienes 24 horas para realizar el pago.`,
                "success",
                6000
            );
            
            // Enviar notificación automática si está configurada
            sendAutoNotification('reserva');
            
            // Limpiar selección
            clearSelection();
            
            // Limpiar formulario
            document.getElementById('uNombre').value = '';
            document.getElementById('uCiudad').value = '';
            document.getElementById('uCelular').value = '';
            
            // Limpiar datos de reserva
            currentReservationData = null;
            
            // Actualizar UI
            updateUI();
        }
        
        function sendAutoNotification(type) {
            if (!currentReservationData || !WHATSAPP_NUMBER) return;
            
            let mensaje = '';
            const numerosStr = currentReservationData.numeros.join(', ');
            const totalFormatted = currentReservationData.total.toLocaleString('es-CO');
            
            // Usar plantillas guardadas o predeterminadas
            if (window.db.notifications && window.db.notifications[type]) {
                mensaje = window.db.notifications[type]
                    .replace('{numeros}', numerosStr)
                    .replace('{total}', totalFormatted)
                    .replace('{nombre}', currentReservationData.nombre);
            } else {
                // Mensajes predeterminados
                switch(type) {
                    case 'reserva':
                        mensaje = `✅ Reserva confirmada para ${currentReservationData.nombre}. Números: ${numerosStr}. Total: $${totalFormatted}. Tienes 24 horas para realizar el pago.`;
                        break;
                    case 'pago':
                        mensaje = `🎉 ¡Pago confirmado! Tus números ${numerosStr} están oficialmente registrados. ¡Buena suerte!`;
                        break;
                    case 'recordatorio':
                        mensaje = `⏰ Recordatorio: Tienes pendiente el pago de ${currentReservationData.numeros.length} números. Total: $${totalFormatted}.`;
                        break;
                }
            }
            
            // Crear URL de WhatsApp
            const mensajeCodificado = encodeURIComponent(mensaje);
            const whatsappUrl = `https://wa.me/${currentReservationData.celular}?text=${mensajeCodificado}`;
            
            // Abrir WhatsApp en nueva pestaña (simulado para este ejemplo)
            // producción, esto podría manejarse de forma diferente
            console.log("Notificación automática:", mensaje);
            console.log("URL:", whatsappUrl);
            
            // Aquí podrías implementar envío automático real si tienes un servidor
            // Por ahora solo mostramos el mensaje
            if (type === 'reserva') {
                showNotification("Notificación de reserva enviada al participante", "success");
            }
        }

        // =============================================
        // PANEL ADMINISTRADOR
        // =============================================
        
    function adminLogin() {
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPass').value;
    const spinner = document.getElementById('loginSpinner');
    const loginText = document.getElementById('loginText');
    
    // Validación básica
    if (!email || !password) {
        showNotification("Ingresa correo y contraseña", "error");
        return;
    }
    
    // Verificar que Firebase esté disponible
    if (!isFirebaseReady || !auth) {
        showNotification("Firebase no está disponible. Verifica la configuración.", "error");
        console.error("Firebase no inicializado:", { isFirebaseReady, auth });
        return;
    }
    
    // Mostrar loading
    loginText.textContent = "Iniciando sesión...";
    spinner.classList.remove('hidden');
    
    // Autenticar con Firebase Authentication (SEGURO)
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // Login exitoso
            currentUser = userCredential.user;
            window.db.isAdmin = true;
            save();
            
            console.log("✅ Admin autenticado:", currentUser.email);
            
            showTab('admin-panel');
            loadFirebaseData();
            showNotification("Bienvenido Administrador", "success");
            
            // Restaurar botón
            loginText.textContent = "Entrar al Panel";
            spinner.classList.add('hidden');
        })
        .catch((error) => {
            // Login fallido
            console.error("❌ Firebase auth error:", error);
            
            let errorMessage = "Credenciales incorrectas";
            
            // Mensajes de error específicos según el código
            switch(error.code) {
                case 'auth/user-not-found':
                    errorMessage = "❌ Usuario no encontrado. Verifica el correo.";
                    break;
                case 'auth/wrong-password':
                    errorMessage = "❌ Contraseña incorrecta.";
                    break;
                case 'auth/invalid-email':
                    errorMessage = "❌ Formato de correo inválido.";
                    break;
                case 'auth/user-disabled':
                    errorMessage = "❌ Esta cuenta ha sido deshabilitada.";
                    break;
                case 'auth/too-many-requests':
                    errorMessage = "⚠️ Demasiados intentos fallidos. Intenta en unos minutos.";
                    break;
                case 'auth/network-request-failed':
                    errorMessage = "🌐 Error de conexión. Verifica tu internet.";
                    break;
                case 'auth/invalid-credential':
                    errorMessage = "❌ Credenciales inválidas. Verifica correo y contraseña.";
                    break;
            }
            
            showNotification(errorMessage, "error", 5000);
            logFailedAttempt(`Intento de login fallido: ${error.code} - ${email}`);
            
            // Restaurar botón
            loginText.textContent = "Entrar al Panel";
            spinner.classList.add('hidden');
        });
}
        
        function adminLogout() {
            window.db.isAdmin = false;
            save();
            
            // Cerrar sesión de Firebase si está autenticado
            if (auth && currentUser) {
                auth.signOut();
                currentUser = null;
            }
            
            showTab('user');
            showNotification("Sesión cerrada", "info");
        }
        
        function updateAdminPanel() {
            if (!window.db.isAdmin) return;
            
            // Calcular estadísticas
            let totalRecaudado = 0;
            let totalPendiente = 0;
            let vendidos = 0;
            let pagados = 0;
            const participantes = new Set();
            
            Object.values(window.db.soldNumbers).forEach(venta => {
                if (venta.pagado) {
                    totalRecaudado += venta.total || (1 * window.db.price);
                    pagados++;
                } else {
                    totalPendiente += venta.total || (1 * window.db.price);
                }
                vendidos++;
                participantes.add(venta.celular);
            });
            
            // Actualizar estadísticas
            document.getElementById('statRecaudado').textContent = `$${totalRecaudado.toLocaleString('es-CO')}`;
            document.getElementById('statPendiente').textContent = `$${totalPendiente.toLocaleString('es-CO')}`;
            document.getElementById('statVendidos').textContent = `${vendidos}/${TOTAL_NUMBERS}`;
            document.getElementById('statParticipantes').textContent = participantes.size;
            
            // Actualizar barra de progreso
            const porcentaje = (vendidos / TOTAL_NUMBERS) * 100;
            document.getElementById('progFill').style.width = `${porcentaje}%`;
            document.getElementById('progText').textContent = 
                `${vendidos}/${TOTAL_NUMBERS} (${porcentaje.toFixed(1)}%)`;
            
            // Actualizar tabla
            updateAdminTable();
            
            // Actualizar panel de seguridad
            updateSecurityPanel();
        }
        
        function updateAdminTable() {
            const tableBody = document.getElementById('salesTable');
            const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
            
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Convertir soldNumbers a array y ordenar
            const ventasArray = Object.entries(window.db.soldNumbers)
                .map(([numero, datos]) => ({ numero, ...datos }))
                .sort((a, b) => b.timestamp - a.timestamp);
            
            // Filtrar por búsqueda
            const ventasFiltradas = ventasArray.filter(venta => {
                if (!searchTerm) return true;
                
                return venta.numero.includes(searchTerm) ||
                       venta.nombre.toLowerCase().includes(searchTerm) ||
                       venta.ciudad.toLowerCase().includes(searchTerm) ||
                       venta.celular.includes(searchTerm);
            });
            
            // Limitar a 100 resultados para rendimiento
            const ventasMostrar = ventasFiltradas.slice(0, 100);
            
            if (ventasMostrar.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            ${searchTerm ? 'No se encontraron resultados' : 'No hay ventas registradas'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Agregar filas
            ventasMostrar.forEach(venta => {
                const row = document.createElement('tr');
                
                // Calcular tiempo restante si no está pagado
                let tiempoRestante = '';
                if (!venta.pagado && venta.expira) {
                    const ahora = Date.now();
                    const expira = venta.expira;
                    
                    if (ahora < expira) {
                        const horas = Math.floor((expira - ahora) / (1000 * 60 * 60));
                        const minutos = Math.floor((expira - ahora) / (1000 * 60)) % 60;
                        tiempoRestante = `${horas}h ${minutos}m`;
                    } else {
                        tiempoRestante = 'EXPIRADO';
                    }
                }
                
                row.innerHTML = `
                    <td style="font-weight: 800; color: white;">${venta.numero}</td>
                    <td>
                        <div style="color: white; font-weight: 600;">${venta.nombre}</div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem;">${venta.ciudad}</div>
                    </td>
                    <td style="color: var(--text-secondary);">${venta.celular}</td>
                    <td>
                        ${venta.pagado ? 
                            '<span class="badge bg-paid">Pagado</span>' : 
                            `<span class="badge bg-wait">Apartado</span>
                             <div style="color: var(--warning); font-size: 0.7rem; margin-top: 4px;">
                                <i class="fas fa-clock"></i> ${tiempoRestante}
                             </div>`
                        }
                    </td>
                    <td>
                        ${!venta.pagado ? 
                            `<button class="btn-quick" onclick="markAsPaid('${venta.numero}')" 
                                     style="background: linear-gradient(135deg, var(--success), var(--success-dark)); color: white; border: none;">
                                <i class="fas fa-check"></i> Pagado
                            </button>` : 
                            `<button class="btn-quick" onclick="markAsPending('${venta.numero}')"
                                     style="background: linear-gradient(135deg, var(--warning), var(--warning-dark)); color: black; border: none;">
                                <i class="fas fa-undo"></i> Pendiente
                            </button>`
                        }
                        <button class="btn-quick" onclick="deleteSale('${venta.numero}')"
                                style="background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; border: none; margin-left: 5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function markAsPaid(numero) {
            if (!window.db.soldNumbers[numero]) return;
            
            window.db.soldNumbers[numero].pagado = true;
            window.db.soldNumbers[numero].fechaPago = new Date().toISOString();
            save();
            
            // Sincronizar con Firebase si está disponible
            if (isFirebaseReady && currentUser) {
                saveToFirebase();
            }
            
            updateAdminPanel();
            initGrid(); // Actualizar grid de números
            
            // Enviar notificación automática
            if (window.db.soldNumbers[numero].celular && window.db.notifications) {
                // Simular envío de notificación
                console.log("Notificación de pago enviada a:", window.db.soldNumbers[numero].celular);
            }
            
            showNotification(`Número ${numero} marcado como pagado`, "success");
        }
        
        function markAsPending(numero) {
            if (!window.db.soldNumbers[numero]) return;
            
            window.db.soldNumbers[numero].pagado = false;
            delete window.db.soldNumbers[numero].fechaPago;
            save();
            
            // Sincronizar con Firebase si está disponible
            if (isFirebaseReady && currentUser) {
                saveToFirebase();
            }
            
            updateAdminPanel();
            initGrid();
            showNotification(`Número ${numero} marcado como pendiente`, "warning");
        }
        
        function deleteSale(numero) {
            if (!confirm(`¿Estás seguro de eliminar la venta del número ${numero}?`)) {
                return;
            }
            
            delete window.db.soldNumbers[numero];
            save();
            
            // Sincronizar con Firebase si está disponible
            if (isFirebaseReady && currentUser) {
                saveToFirebase();
            }
            
            updateAdminPanel();
            initGrid();
            showNotification(`Venta del número ${numero} eliminada`, "success");
        }
        
        function clearAllData() {
            if (!confirm("¿ESTÁS SEGURO? Esto eliminará TODOS los datos de ventas. Esta acción NO se puede deshacer.")) {
                return;
            }
            
            window.db.soldNumbers = {};
            save();
            
            // Sincronizar con Firebase si está disponible
            if (isFirebaseReady && currentUser) {
                saveToFirebase();
            }
            
            updateAdminPanel();
            initGrid();
            showNotification("Todos los datos han sido eliminados", "success");
        }
        
        function exportToExcel() {
            // Crear datos para exportar
            const data = [];
            
            // Encabezados
            data.push(['Número', 'Nombre', 'Ciudad', 'Celular', 'Estado', 'Total', 'Fecha', 'Método']);
            
            // Datos
            Object.entries(window.db.soldNumbers).forEach(([numero, venta]) => {
                data.push([
                    numero,
                    venta.nombre,
                    venta.ciudad,
                    venta.celular,
                    venta.pagado ? 'Pagado' : 'Apartado',
                    `$${(venta.total || window.db.price).toLocaleString('es-CO')}`,
                    new Date(venta.timestamp).toLocaleDateString('es-CO'),
                    venta.metodo || 'N/A'
                ]);
            });
            
            // Convertir a CSV
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, 'ventas_sorteo.csv');
            } else {
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', 'ventas_sorteo.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            showNotification("Datos exportados a CSV", "success");
        }
        
        function showInstructions() {
            alert(`📖 INSTRUCCIONES SB DINÁMICAS

1. SELECCIÓN DE NÚMEROS:
   - Haz clic en los números que quieras reservar
   - Máximo 20 números por transacción
   - Usa el buscador para encontrar números específicos

2. COMPLETAR DATOS:
   - Ingresa tu nombre completo (nombre y apellido)
   - Selecciona tu ciudad de la lista permitida
   - Ingresa tu número de celular colombiano

3. RESERVA:
   - La reserva es válida por 24 horas
   - Debes realizar el pago dentro de este tiempo
   - Recibirás confirmación por WhatsApp

4. PAGO:
   - Selecciona tu método de pago preferido
   - Sigue las instrucciones para completar el pago
   - Envía el comprobante por WhatsApp

5. CONFIRMACIÓN:
   - Una vez confirmado el pago, tus números quedan registrados
   - Recibirás notificación de confirmación

⚠️ SEGURIDAD:
   - Tus datos están protegidos
   - Transacciones seguras
   - Sistema anti-fraude implementado

Para soporte, contacta al administrador del sorteo.`);
        }

        // =============================================
        // PANEL DE SEGURIDAD
        // =============================================
        
        function toggleSecurityPanel() {
            const panel = document.getElementById('securityPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                updateSecurityPanel();
            } else {
                panel.style.display = 'none';
            }
        }
        
        function updateSecurityPanel() {
            if (!window.db.isAdmin) return;
            
            // Calcular estadísticas de seguridad
            cleanupExpiredBlocks();
            
            const blockedIPs = Object.keys(window.securityLog.tempBlocks).length;
            const failedAttempts = Object.values(window.securityLog.failedAttempts)
                .reduce((sum, attempt) => sum + attempt.count, 0);
            
            // Calcular usuarios activos hoy
            const todayStart = new Date().setHours(0, 0, 0, 0);
            const activeUsers = new Set();
            
            Object.entries(window.securityLog.userActivity).forEach(([userKey, activity]) => {
                const recentTransactions = activity.transactions.filter(t => 
                    t.timestamp >= todayStart
                );
                if (recentTransactions.length > 0) {
                    activeUsers.add(userKey);
                }
            });
            
            // Calcular actividad sospechosa
            let suspiciousActivity = 0;
            Object.entries(window.securityLog.failedAttempts).forEach(([ip, attempt]) => {
                if (attempt.count >= 3) {
                    suspiciousActivity++;
                }
            });
            
            // Actualizar estadísticas
            document.getElementById('statBlocked').textContent = blockedIPs;
            document.getElementById('statAttempts').textContent = failedAttempts;
            document.getElementById('statActive').textContent = activeUsers.size;
            document.getElementById('statSuspicious').textContent = suspiciousActivity;
            
            // Actualizar lista de IPs bloqueadas
            updateBlockedIPsList();
            
            // Actualizar detalles de seguridad
            updateSecurityDetails();
        }
        
        function updateBlockedIPsList() {
            const listEl = document.getElementById('blockedIPsList');
            if (!listEl) return;
            
            const blockedEntries = Object.entries(window.securityLog.tempBlocks);
            
            if (blockedEntries.length === 0) {
                listEl.innerHTML = `
                    <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                        No hay IPs bloqueadas
                    </div>
                `;
                return;
            }
            
            let html = '';
            const now = Date.now();
            
            blockedEntries.forEach(([blockKey, expires]) => {
                const ip = blockKey.replace('block-', '');
                const remaining = Math.ceil((expires - now) / 60000); // minutos
                
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid var(--glass-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: white; font-weight: 600;">${ip}</div>
                            <div style="color: var(--accent); font-size: 0.8rem;">
                                ${remaining > 0 ? `${remaining} min restantes` : 'Expirado'}
                            </div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 5px;">
                            Bloqueado por múltiples intentos fallidos
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        function clearAllBlocks() {
            if (!confirm("¿Desbloquear todas las IPs bloqueadas?")) return;
            
            window.securityLog.tempBlocks = {};
            window.securityLog.save();
            
            updateSecurityPanel();
            showNotification("Todas las IPs han sido desbloqueadas", "success");
        }
        
        function exportSecurityLog() {
            const logData = {
                fecha: new Date().toISOString(),
                bloqueados: window.securityLog.tempBlocks,
                intentosFallidos: window.securityLog.failedAttempts,
                actividadUsuarios: window.securityLog.userActivity,
                transacciones: window.securityLog.transactionLog.slice(-100)
            };
            
            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `security_log_${Date.now()}.json`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification("Logs de seguridad exportados", "success");
        }
        
        function toggleSecurityDetails() {
            const detailsEl = document.getElementById('securityDetails');
            if (detailsEl.style.display === 'none') {
                detailsEl.style.display = 'block';
                updateSecurityDetails();
            } else {
                detailsEl.style.display = 'none';
            }
        }
        
        function updateSecurityDetails() {
            const detailsEl = document.getElementById('securityStatsDetails');
            if (!detailsEl) return;
            
            // Calcular estadísticas detalladas
            const ahora = Date.now();
            const ultimas24h = ahora - (24 * 60 * 60 * 1000);
            const ultimaHora = ahora - (60 * 60 * 1000);
            
            let transacciones24h = 0;
            let transacciones1h = 0;
            let numerosVendidos24h = 0;
            
            Object.values(window.securityLog.userActivity).forEach(activity => {
                activity.transactions.forEach(trans => {
                    if (trans.timestamp >= ultimas24h) {
                        transacciones24h++;
                        numerosVendidos24h += trans.numbersCount;
                        
                        if (trans.timestamp >= ultimaHora) {
                            transacciones1h++;
                        }
                    }
                });
            });
            
            let intentosFallidos24h = 0;
            Object.values(window.securityLog.failedAttempts).forEach(attempt => {
                if (attempt.lastAttempt >= ultimas24h) {
                    intentosFallidos24h += attempt.count;
                }
            });
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="color: var(--text-secondary); font-size: 0.7rem;">Transacciones (24h)</div>
                        <div style="color: white; font-size: 1.2rem; font-weight: 800;">${transacciones24h}</div>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="color: var(--text-secondary); font-size: 0.7rem;">Transacciones (1h)</div>
                        <div style="color: white; font-size: 1.2rem; font-weight: 800;">${transacciones1h}</div>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="color: var(--text-secondary); font-size: 0.7rem;">Números vendidos (24h)</div>
                        <div style="color: white; font-size: 1.2rem; font-weight: 800;">${numerosVendidos24h}</div>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="color: var(--text-secondary); font-size: 0.7rem;">Intentos fallidos (24h)</div>
                        <div style="color: white; font-size: 1.2rem; font-weight: 800;">${intentosFallidos24h}</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 8px;">
                        <i class="fas fa-info-circle"></i> Resumen de seguridad:
                    </div>
                    <div style="color: var(--text-secondary); font-size: 0.75rem; line-height: 1.4;">
                        • Sistema activo y monitoreando en tiempo real<br>
                        • ${transacciones24h} transacciones en las últimas 24 horas<br>
                        • ${Object.keys(window.securityLog.userActivity).length} usuarios únicos registrados<br>
                        • ${Object.keys(window.securityLog.tempBlocks).length} IPs actualmente bloqueadas
                    </div>
                </div>
            `;
            
            detailsEl.innerHTML = html;
        }
        
        function refreshSecurityPanel() {
            updateSecurityPanel();
            showNotification("Panel de seguridad actualizado", "success");
        }

        // =============================================
        // INICIALIZACIÓN DE LA APLICACIÓN
        // =============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar Firebase
            initFirebase();
            
            // Inicializar WhatsApp
            initWhatsAppNumber();
            
            // Inicializar UI
            updateUI();
            
            // Configurar limpieza automática cada 5 minutos
            setInterval(() => {
                cleanupExpiredBlocks();
            }, 5 * 60 * 1000);
            
            // Actualizar contador cada minuto
            setInterval(() => {
                actualizarContadorSorteo();
            }, 60 * 1000);
            
            console.log("✅ SB DINÁMICAS Premium inicializado");
            console.log("✅ Firebase:", isFirebaseReady ? "Conectado" : "Modo offline");
            console.log("✅ WhatsApp:", WHATSAPP_NUMBER ? "Configurado" : "No configurado");
            console.log("✅ Seguridad: Sistema activo");
            
            // Mostrar notificación de bienvenida
            setTimeout(() => {
                showNotification("Bienvenido a SB DINÁMICAS Premium", "success", 3000);
            }, 1000);
        });
    </script>
</body>
</html>
