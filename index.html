tu<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SB DIN츼MICAS - Sorteos Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
    <style>
        .number-item:active {
            transform: scale(0.9);
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #f43f5e;
            --accent-dark: #e11d48;
            --success: #22c55e;
            --success-dark: #16a34a;
            --warning: #fbbf24;
            --warning-dark: #f59e0b;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-dark: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-secondary: #94a3b8;
            --color-libre: rgba(255, 255, 255, 0.03);
            --color-seleccionado: #6366f1;
            --color-apartado: #fbbf24;
            --color-pagado: #22c55e;
            --bg-gradient: radial-gradient(circle at top right, #0f172a, #020617);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            padding: 15px;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(244, 63, 94, 0.1) 0%, transparent 50%);
            z-index: -1;
            pointer-events: none;
        }
        
        /* ANIMACIONES */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        /* GLASS EFFECT PREMIUM */
        .glass-effect {
            background: var(--glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .glass-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.05),
                transparent
            );
            transition: left 0.6s ease;
        }
        
        .glass-effect:hover::before {
            left: 100%;
        }
        
        header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            background: linear-gradient(135deg, #fbbf24, #22c55e, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, transparent, #6366f1, transparent);
            border-radius: 2px;
        }
        
        /* BUSCADOR PREMIUM */
        .quick-search-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 0 5px;
        }
        
        .search-input-group {
            flex: 1;
            position: relative;
        }
        
        .search-input {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid transparent;
            padding: 14px 45px 14px 15px;
            border-radius: 14px;
            color: white;
            width: 100%;
            outline: none;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)) padding-box,
                      linear-gradient(135deg, var(--primary), var(--accent)) border-box;
        }
        
        .search-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* BOTONES PREMIUM */
        .btn {
            padding: 14px 24px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1), 
                rgba(255, 255, 255, 0.05));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn:hover::before {
            opacity: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 10px 30px rgba(99, 102, 241, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
            width: 100%;
            font-size: 1.1rem;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
        }
        
        .btn-quick {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-quick:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        /* GRID DE N칔MEROS PREMIUM */
        .numbers-container {
            height: 420px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
            margin-bottom: 20px;
        }
        
        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            gap: 10px;
        }
        
        .number-item {
            aspect-ratio: 1;
            background: var(--color-libre);
            border: 2px solid transparent;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }
        
        .number-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                135deg,
                transparent,
                rgba(255, 255, 255, 0.05),
                transparent
            );
            transform: translateX(-100%);
        }
        
        .number-item:hover::before {
            animation: shimmer 1s ease;
        }
        
        .number-item:hover {
            transform: translateY(-3px) scale(1.05);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .number-item.selected {
            background: linear-gradient(135deg, var(--color-seleccionado), #4f46e5);
            color: white;
            border: none;
            transform: scale(1.08);
            box-shadow: 
                0 0 25px var(--color-seleccionado),
                0 8px 20px rgba(99, 102, 241, 0.4);
            animation: float 3s ease-in-out infinite;
        }
        
        .number-item.apartado {
            background: linear-gradient(135deg, var(--color-apartado), #f59e0b);
            color: #000;
            cursor: not-allowed;
            border: none;
        }
        
        .number-item.pagado {
            background: linear-gradient(135deg, var(--color-pagado), #16a34a);
            color: #fff;
            cursor: not-allowed;
            border: none;
        }
        
        .number-item.highlighted {
            box-shadow: 0 0 0 3px var(--accent);
            border-color: var(--accent);
            z-index: 10;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 3px var(--accent); }
            50% { box-shadow: 0 0 0 6px var(--accent); }
        }
        
        .number-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--accent);
            color: white;
            font-size: 0.55rem;
            padding: 3px 5px;
            border-radius: 6px;
            font-weight: 900;
            min-width: 18px;
            text-align: center;
            box-shadow: 0 3px 8px rgba(244, 63, 94, 0.4);
        }
        
        /* PANEL ADMIN PREMIUM */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 18px;
            border: 1px solid var(--glass-border);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        /* TABLAS PREMIUM */
        .admin-table-container {
            overflow-x: auto;
            margin-top: 15px;
            max-height: 450px;
            overflow-y: auto;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        thead {
            background: rgba(99, 102, 241, 0.1);
            border-bottom: 2px solid var(--glass-border);
        }
        
        th {
            padding: 16px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* BADGES PREMIUM */
        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            display: inline-block;
        }
        
        .bg-wait {
            background: linear-gradient(135deg, var(--warning), var(--warning-dark));
            color: #000;
        }
        
        .bg-paid {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: #fff;
        }
        
        /* PROGRESS BAR PREMIUM */
        .progress-bar-bg {
            background: rgba(0, 0, 0, 0.4);
            height: 22px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
            border: 1px solid var(--glass-border);
        }
        
        .progress-bar-fill {
            background: linear-gradient(90deg, 
                #fbbf24, 
                #22c55e,
                #6366f1);
            height: 100%;
            width: 0%;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite linear;
        }
        
        /* FORMULARIOS PREMIUM */
        input {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid transparent;
            padding: 15px;
            border-radius: 12px;
            color: white;
            width: 100%;
            outline: none;
            margin-bottom: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)) padding-box,
                      linear-gradient(135deg, var(--glass-border), transparent) border-box;
        }
        
        input:focus {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }
        
        input::placeholder {
            color: var(--text-secondary);
        }
        
        /* LOADING STATES */
        .spinner {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* UTILITIES */
        .hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* SCROLLBAR PERSONALIZADA */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(var(--primary), var(--accent));
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.2);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(var(--primary-dark), var(--accent-dark));
        }
        
        /* NOTIFICACIONES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 350px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-left: 4px solid var(--success);
        }
        
        .notification.error {
            border-left: 4px solid var(--accent);
        }
        
        .notification.warning {
            border-left: 4px solid var(--warning);
        }
        
        /* CONFIG ALERT PREMIUM */
        .config-alert {
            background: linear-gradient(135deg, 
                rgba(251, 191, 36, 0.1), 
                rgba(251, 191, 36, 0.05));
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .config-alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--warning), transparent);
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .numbers-grid {
                grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
                gap: 8px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .quick-search-container,
            .quick-select-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-clear-btn,
            .btn-quick {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* ANIMACI칍N DE ENTRADA */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: slideInUp 0.6s ease-out;
        }
        
        /* ESTADO DE SINCRONIZACI칍N */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 12px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            font-size: 0.8rem;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-online {
            color: var(--success);
            border-left: 4px solid var(--success);
        }
        
        .sync-offline {
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }
        
        .sync-error {
            color: var(--accent);
            border-left: 4px solid var(--accent);
        }
    </style>
</head>
<body>
    <!-- NOTIFICACIONES -->
    <div id="notification" class="notification hidden"></div>
    
    <!-- ESTADO DE SINCRONIZACI칍N -->
    <div id="syncStatus" class="sync-status hidden">
        <i class="fas fa-sync-alt"></i>
        <span>Sincronizando...</span>
    </div>
    
    <div class="container">
        <!-- HEADER PREMIUM -->
        <header>
            <div style="position: relative;">
                <h1>SB DIN츼MICAS</h1>
                <p style="color: var(--text-secondary); margin-top: 15px; font-size: 1rem;">
                    <i class="fas fa-gem" style="color: var(--primary); margin-right: 8px;"></i>
                    Plataforma premium de sorteos <span id="linkBioSyncBadge" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px; display: none;">
                        <i class="fas fa-link"></i> Link Bio
                    </span>
                </p>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showTab('user')">
                    <i class="fas fa-ticket-alt"></i> Participar
                </button>
                <button class="btn btn-primary" onclick="showTab('admin-login')">
                    <i class="fas fa-lock"></i> Admin
                </button>
                <button class="btn" style="background: rgba(255,255,255,0.1);" onclick="showInstructions()">
                    <i class="fas fa-question-circle"></i> Ayuda
                </button>
            </div>
        </header>
        
        <!-- VISTA USUARIO -->
        <div id="view-user" class="fade-in">
            <!-- PANEL PREMIO -->
            <div class="glass-effect">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <h2 id="displayPrizeTitle" style="font-size: 1.8rem; background: linear-gradient(135deg, #fbbf24, #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
                        Cargando sorteo...
                    </h2>
                    <span style="background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">
                        <i class="fas fa-fire"></i> ACTIVO
                    </span>
                </div>
                
                <div id="prizeImageContainer" style="display: none; margin: 20px 0;">
                    <img id="displayPrizeImg" style="width:100%; height:280px; object-fit:cover; border-radius:16px; border: 2px solid var(--glass-border);">
                </div>
                
                <p id="displayPrizeDesc" style="color:var(--text-secondary); font-size: 1rem; line-height: 1.6; margin-bottom: 20px;"></p>
                
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="color:var(--warning); margin-bottom: 5px;">
                                <i class="fas fa-ticket-alt"></i> Valor por boleto:
                            </h3>
                            <div style="font-size: 2.2rem; font-weight: 800; color: white;">
                                $<span id="displayPrice">0</span> <small style="font-size: 1rem; color: var(--text-secondary);">COP</small>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">
                                <i class="fas fa-bolt"></i> R치pido y seguro
                            </div>
                            <div style="font-size: 0.8rem; color: var(--primary);">
                                <i class="fas fa-shield-alt"></i> Transacci칩n protegida
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ALERTA WHATSAPP -->
                <div id="whatsappAlert" class="config-alert hidden">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 1.5rem; margin-bottom: 10px;"></i>
                    <p><strong style="color: white; font-size: 1.1rem;">丘멆잺 WhatsApp no configurado</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: var(--text-secondary);">
                        El administrador debe configurar el n칰mero de WhatsApp para poder apartar n칰meros.
                        <br>
                        <small style="opacity: 0.8;">Por favor, contacta al organizador del sorteo.</small>
                    </p>
                </div>
            </div>
            
            <!-- PANEL SELECCI칍N DE N칔MEROS -->
            <div class="glass-effect">
                <!-- BUSCADOR R츼PIDO -->
                <div class="quick-search-container">
                    <div class="search-input-group">
                        <input type="text" 
                               class="search-input" 
                               id="numberSearch" 
                               placeholder="Buscar n칰mero (Ej: 001, 123...)"
                               maxlength="3"
                               oninput="searchNumbers()">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <button class="search-clear-btn btn" onclick="clearSearch()" style="background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.1)); border: 1px solid rgba(244, 63, 94, 0.3); color: #fb7185;">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
                
                <!-- RESULTADOS DE B칔SQUEDA -->
                <div id="searchResultsInfo" class="search-results-info hidden" style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; margin: 15px 0; text-align: center; color: var(--text-secondary); font-size: 0.9rem;"></div>
                
                <!-- SELECCI칍N R츼PIDA -->
                <div class="quick-select-container" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 0 5px;">
                    <span class="quick-label" style="font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">
                        <i class="fas fa-dice"></i> Selecci칩n r치pida:
                    </span>
                    <div class="quick-group" style="display: flex; gap: 8px;">
                        <button class="btn-quick" onclick="selectRandom(5)">
                            <i class="fas fa-random"></i> 5
                        </button>
                        <button class="btn-quick" onclick="selectRandom(10)">10</button>
                        <button class="btn-quick" onclick="selectRandom(20)">20</button>
                        <button class="btn-quick" onclick="clearSelection()" style="background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.1)); border-color: rgba(244, 63, 94, 0.3); color: #fb7185;">
                            <i class="fas fa-undo"></i> Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- CONTENEDOR DE N칔MEROS -->
                <div class="numbers-container">
                    <div class="numbers-grid" id="mainGrid"></div>
                </div>
                
                <!-- LEYENDA DE COLORES -->
                <div class="legend-container" style="display: flex; justify-content: center; gap: 25px; margin-top: 25px; flex-wrap: wrap;">
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <span class="legend-color" style="width: 14px; height: 14px; border-radius: 4px; background: var(--color-libre); border: 1px solid var(--glass-border);"></span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Disponible</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <span class="legend-color" style="width: 14px; height: 14px; border-radius: 4px; background: linear-gradient(135deg, var(--color-seleccionado), #4f46e5);"></span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Seleccionado</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <span class="legend-color" style="width: 14px; height: 14px; border-radius: 4px; background: linear-gradient(135deg, var(--color-apartado), #f59e0b);"></span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Apartado</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <span class="legend-color" style="width: 14px; height: 14px; border-radius: 4px; background: linear-gradient(135deg, var(--color-pagado), #16a34a);"></span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Pagado</span>
                    </div>
                </div>
                
                <!-- RESUMEN DE SELECCI칍N -->
                <div id="selectionSummary" style="margin: 25px 0; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 16px; border: 1px solid var(--glass-border); min-height: 60px; text-align: center;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> Selecciona tus n칰meros
                    </div>
                </div>
            </div>
            
            <!-- FORMULARIO DE USUARIO -->
            <div class="glass-effect">
                <h3 style="color: white; margin-bottom: 20px; font-size: 1.3rem;">
                    <i class="fas fa-user-circle"></i> Tus Datos
                </h3>
                
                <div class="form-user">
                    <input type="text" id="uNombre" placeholder="Nombre completo *" required>
                    <input type="text" id="uCiudad" placeholder="Ciudad (Ej: Cali) *" required>
                    <input type="tel" id="uCelular" placeholder="Celular (Ej: 3001234567) *" required pattern="[0-9]{10}" maxlength="10">
                </div>
                
                <div style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 0.85rem;">
                        <i class="fas fa-shield-alt" style="color: var(--primary);"></i>
                        <span>Tus datos est치n protegidos y solo se usar치n para el sorteo.</span>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="sendWhatsApp()" id="btnWhatsApp">
                    <i class="fab fa-whatsapp"></i> APARTAR POR WHATSAPP
                    <span id="selectedCountBadge" style="background: white; color: var(--success-dark); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 8px; display: none;">0</span>
                </button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">
                        <i class="fas fa-clock"></i> La reserva es v치lida por 24 horas
                    </small>
                </div>
            </div>
        </div>
        
        <!-- VISTA LOGIN ADMIN -->
        <div id="view-admin-login" class="hidden">
            <div class="glass-effect" style="max-width: 400px; margin: 40px auto;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <i class="fas fa-lock" style="color: white; font-size: 2rem;"></i>
                    </div>
                    <h2 style="color: white; font-size: 1.8rem;">Acceso Administrador</h2>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Ingresa tus credenciales</p>
                </div>
                
                <input type="email" id="adminEmail" placeholder="Correo electr칩nico" required>
                <input type="password" id="adminPass" placeholder="Contrase침a" required>
                
                <button class="btn btn-primary" style="width:100%; margin-top: 25px;" id="btnLoginFirebase">
                    <span id="loginText">Entrar al Panel</span>
                    <span id="loginSpinner" class="spinner hidden" style="margin-left: 10px;"></span>
                </button>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" style="background: none; color: var(--text-secondary); font-size: 0.9rem;" onclick="showTab('user')">
                        <i class="fas fa-arrow-left"></i> Volver al sorteo
                    </button>
                </div>
            </div>
        </div>
        
        <!-- PANEL ADMIN -->
        <div id="view-admin-panel" class="hidden">
            <!-- ESTAD칈STICAS -->
            <div class="admin-stats">
                <div class="stat-card">
                    <h4 style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px;">
                        <i class="fas fa-check-circle"></i> Confirmado
                    </h4>
                    <p id="statRecaudado" style="font-size: 1.8rem; font-weight: 800; color: var(--success); margin: 5px 0;">$0</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Total recaudado</small>
                </div>
                <div class="stat-card">
                    <h4 style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px;">
                        <i class="fas fa-clock"></i> Por Cobrar
                    </h4>
                    <p id="statPendiente" style="font-size: 1.8rem; font-weight: 800; color: var(--warning); margin: 5px 0;">$0</p>
                    <small style="color: var(--text-secondary); font-size: 0.75rem;">Pendiente de pago</small>
                </div>
            </div>
            
            <!-- PANEL PRINCIPAL ADMIN -->
            <div class="glass-effect">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="color: white; font-size: 1.5rem;">
                        <i class="fas fa-chart-line"></i> Gesti칩n de Ventas
                    </h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-quick" onclick="exportToExcel()" title="Exportar a Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                        <button class="btn-quick" onclick="showTab('admin-config')">
                            <i class="fas fa-cog"></i> Configurar
                        </button>
                        <button class="btn-quick" onclick="sincronizarAhora()" title="Sincronizar con Link Bio">
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                    </div>
                </div>
                
                <!-- BARRA DE PROGRESO -->
                <div style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">Progreso del sorteo</span>
                        <span id="progText" style="font-size: 0.9rem; font-weight: 700; color: var(--primary);">0/1000 (0%)</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progFill"></div>
                    </div>
                </div>
                
                <!-- BUSCADOR ADMIN -->
                <input type="text" id="adminSearch" placeholder="游댌 Buscar por n칰mero, nombre o ciudad..." oninput="updateUI()" style="margin-bottom: 20px;">
                
                <!-- TABLA DE VENTAS -->
                <div class="admin-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>N칰mero</th>
                                <th>Participante</th>
                                <th>Estado</th>
                                <th>Origen</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable"></tbody>
                    </table>
                </div>
                
                <!-- BOTONES DE ACCI칍N -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 25px;">
                    <button class="btn" onclick="showTab('admin-config')" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.1)); border: 1px solid rgba(99, 102, 241, 0.3); color: #a5b4fc;">
                        <i class="fas fa-cog"></i> Configurar
                    </button>
                    <button class="btn" onclick="clearAllData()" style="background: linear-gradient(135deg, rgba(244, 63, 94, 0.15), rgba(244, 63, 94, 0.1)); border: 1px solid rgba(244, 63, 94, 0.3); color: #fb7185;">
                        <i class="fas fa-trash"></i> Resetear Todo
                    </button>
                </div>
                
                <button class="btn" onclick="forceSync()" style="width:100%; margin-top:15px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color:white; border: none;">
                    <i class="fas fa-sync-alt"></i> Sincronizar con Firebase
                </button>
                
                <button class="btn" id="btnLogout" style="width:100%; margin-top:10px; background:none; color:var(--text-secondary); border: 1px solid var(--glass-border);">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi칩n
                </button>
            </div>
        </div>
        
        <!-- CONFIGURACI칍N ADMIN -->
        <div id="view-admin-config" class="hidden">
            <!-- CONFIGURACI칍N COMPLETA DEL SORTEO -->
            <div class="glass-effect">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="color: white; font-size: 1.5rem;">
                        <i class="fas fa-cogs"></i> Configuraci칩n Completa del Sorteo
                    </h3>
                    <button class="btn-quick" onclick="showTab('admin-panel')">
                        <i class="fas fa-arrow-left"></i> Volver
                    </button>
                </div>
                
                <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; color: var(--warning);">
                        <i class="fas fa-info-circle"></i>
                        <span style="font-size: 0.9rem;">Configura todos los detalles del sorteo que ver치n los participantes</span>
                    </div>
                </div>
                
                <div class="form-user">
                    <!-- T칈TULO PRINCIPAL -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-heading"></i> T칤tulo Principal *
                        </label>
                        <input type="text" 
                               id="configTitulo" 
                               placeholder="Ej: GRAN SORTEO ANIVERSARIO SB DIN츼MICAS"
                               maxlength="100"
                               style="font-size: 1.1rem; font-weight: 600;">
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Este es el t칤tulo principal que ver치n los participantes (m치x. 100 caracteres)
                        </small>
                    </div>
                    
                    <!-- SUBT칈TULO O DESCRIPCI칍N -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-align-left"></i> Descripci칩n / Subt칤tulo *
                        </label>
                        <textarea id="configDescripcion" 
                                  placeholder="Describe el premio, condiciones y detalles importantes del sorteo..."
                                  style="background: rgba(0,0,0,0.4); border: 2px solid transparent; padding: 15px; border-radius: 12px; color: white; width: 100%; outline: none; margin-bottom: 12px; font-size: 0.95rem; min-height: 100px; resize: vertical; font-family: inherit; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)) padding-box, linear-gradient(135deg, var(--glass-border), transparent) border-box;"></textarea>
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Describe el premio principal, reglas del sorteo y cualquier informaci칩n relevante
                        </small>
                    </div>
                    
                    <!-- VALOR DEL BOLETO -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-tag"></i> Valor por Boleto *
                        </label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: white; font-weight: 600;">$</span>
                            <input type="number" 
                                   id="configValor" 
                                   placeholder="Ej: 20000"
                                   min="1000" 
                                   step="1000"
                                   style="flex: 1;">
                            <span style="color: var(--text-secondary);">COP</span>
                        </div>
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Precio que pagar치n los participantes por cada n칰mero (m칤nimo $1,000)
                        </small>
                    </div>
                    
                    <!-- FECHA DEL SORTEO -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-calendar-alt"></i> Fecha del Sorteo *
                        </label>
                        <input type="datetime-local" 
                               id="configFecha"
                               style="background: rgba(0,0,0,0.4); border: 2px solid transparent; padding: 15px; border-radius: 12px; color: white; width: 100%; outline: none; font-size: 0.95rem; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)) padding-box, linear-gradient(135deg, var(--glass-border), transparent) border-box;">
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Fecha y hora en que se realizar치 el sorteo. Los participantes ver치n un contador.
                        </small>
                    </div>
                    
                    <!-- PIE DE P츼GINA / INFORMACI칍N ADICIONAL -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-file-alt"></i> Informaci칩n Adicional / Pie de P치gina
                        </label>
                        <textarea id="configPiePagina" 
                                  placeholder="Informaci칩n adicional, t칠rminos y condiciones, m칠todos de pago, contacto..."
                                  style="background: rgba(0,0,0,0.4); border: 2px solid transparent; padding: 15px; border-radius: 12px; color: white; width: 100%; outline: none; margin-bottom: 12px; font-size: 0.9rem; min-height: 120px; resize: vertical; font-family: inherit; background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)) padding-box, linear-gradient(135deg, var(--glass-border), transparent) border-box;"></textarea>
                        <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                            Informaci칩n que aparecer치 en la parte inferior. Puedes incluir t칠rminos, condiciones y datos de contacto.
                        </small>
                    </div>
                    
                    <!-- IMAGEN DEL PREMIO -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-image"></i> Imagen del Premio
                        </label>
                        <div style="border: 2px dashed var(--glass-border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; position: relative;"
                             onclick="document.getElementById('configImagenFile').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 10px;"></i>
                            <div style="color: white; font-weight: 600; margin-bottom: 5px;">Subir Imagen del Premio</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">
                                Haz clic para seleccionar una imagen (JPG, PNG, GIF - M치x. 5MB)
                            </div>
                            <input type="file" 
                                   id="configImagenFile" 
                                   accept="image/*" 
                                   onchange="uploadConfigImage(this)"
                                   style="display: none;">
                        </div>
                        
                        <!-- VISTA PREVIA DE LA IMAGEN -->
                        <div id="configImagenPreview" style="margin-top: 15px; display: none;">
                            <div style="color: white; margin-bottom: 10px; font-size: 0.9rem;">
                                <i class="fas fa-eye"></i> Vista previa:
                            </div>
                            <img id="configImagenPreviewImg" 
                                 style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 2px solid var(--glass-border);">
                        </div>
                    </div>
                    
                    <!-- COLORES PERSONALIZADOS (OPCIONAL) -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; color: white; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-palette"></i> Color Principal del Sorteo
                        </label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="color" 
                                   id="configColorPrincipal" 
                                   value="#6366f1"
                                   style="width: 60px; height: 60px; border-radius: 10px; border: 2px solid var(--glass-border); cursor: pointer;">
                            <div>
                                <div style="color: white; font-size: 0.9rem;">Color principal</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">
                                    Afecta botones, n칰meros seleccionados y acentos
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BOTONES DE ACCI칍N -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px;">
                    <button class="btn" onclick="cargarConfiguracionActual()" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.1)); border: 1px solid rgba(99, 102, 241, 0.3); color: #a5b4fc;">
                        <i class="fas fa-sync-alt"></i> Cargar Actual
                    </button>
                    <button class="btn btn-primary" onclick="guardarConfiguracionCompleta()">
                        <i class="fas fa-save"></i> Guardar Todo
                    </button>
                </div>
                
                <!-- ESTADO DE LA CONFIGURACI칍N -->
                <div id="configCompletaStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
                
                <!-- VISTA PREVIA R츼PIDA -->
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 16px; margin-top: 25px; border: 1px solid var(--glass-border);">
                    <h4 style="color: white; margin-bottom: 15px; font-size: 1.1rem;">
                        <i class="fas fa-desktop"></i> Vista Previa
                    </h4>
                    <div id="configPreview" style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                        Los cambios se mostrar치n aqu칤...
                    </div>
                    <button class="btn" onclick="actualizarVistaPrevia()" style="margin-top: 15px; width: 100%; background: rgba(255,255,255,0.05);">
                        <i class="fas fa-redo"></i> Actualizar Vista Previa
                    </button>
                </div>
            </div>
            
            <!-- CONFIGURACI칍N DE WHATSAPP -->
            <div class="glass-effect" style="margin-top: 20px;">
                <h3 style="color: white; margin-bottom: 20px; font-size: 1.5rem;">
                    <i class="fab fa-whatsapp"></i> Configurar WhatsApp
                </h3>
                
                <div class="config-alert">
                    <i class="fas fa-shield-alt" style="color: var(--primary); font-size: 1.2rem; margin-bottom: 10px;"></i>
                    <p><strong style="color: white; font-size: 1rem;">游 Protege tu n칰mero de WhatsApp</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: var(--text-secondary);">
                        Configura aqu칤 tu n칰mero para recibir reservas. No lo compartas p칰blicamente.
                    </p>
                </div>
                
                <div class="form-user">
                    <input type="text" 
                           id="whatsappConfig" 
                           placeholder="Ej: 573001234567 (57 + 10 d칤gitos)"
                           maxlength="12"
                           pattern="57\d{10}">
                    <small style="color: var(--text-secondary); font-size: 0.8rem; margin-top: -8px; margin-bottom: 15px; display: block;">
                        <strong>Formato:</strong> 57 + n칰mero de celular (10 d칤gitos)
                    </small>
                </div>
                
                <button class="btn btn-primary" style="width: 100%;" onclick="saveWhatsAppConfig()">
                    <i class="fas fa-save"></i> Guardar N칰mero WhatsApp
                </button>
                
                <div id="whatsappStatus" style="margin-top: 15px; padding: 12px; border-radius: 8px; display: none;"></div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--glass-border);">
                    <h4 style="color: white; margin-bottom: 10px; font-size: 1rem;">
                        <i class="fas fa-info-circle"></i> Estado actual:
                    </h4>
                    <div id="whatsappCurrent" style="color: var(--text-secondary); font-size: 0.9rem;">
                        Cargando...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
    
    <!-- FIREBASE PARA SINCRONIZACI칍N CON LINK BIO -->
    <script type="module">
    // ============================================
    // CONFIGURACI칍N DE FIREBASE PARA LINK BIO
    // ============================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
        getFirestore, 
        doc, 
        updateDoc, 
        increment, 
        arrayUnion, 
        addDoc, 
        collection,
        serverTimestamp,
        getDoc,
        getDocs,
        query,
        where,
        orderBy,
        setDoc  // 救 AGREGADO
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    
    // Configuraci칩n de Firebase para Link Bio
    const firebaseConfigLinkBio = {
        apiKey: "AIzaSyBj4J3ZsJZyp8KKnysRyYQkJ7CllrCw4Uk",
        authDomain: "sb-dinamicas.firebaseapp.com",
        projectId: "sb-dinamicas",
        storageBucket: "sb-dinamicas.firebasestorage.app",
        messagingSenderId: "1058846798988",
        appId: "1:1058846798988:web:e27b59f99b30bcf98977a9"
    };
    
    // 游댠 CORRECCI칍N 1: Verificar si ya existe una app con ese nombre
    let linkBioApp;
    let linkBioDb;
    
    try {
        // Intentar obtener la app existente
        linkBioApp = initializeApp(firebaseConfigLinkBio, "linkBioApp");
        linkBioDb = getFirestore(linkBioApp);
        console.log("九 Firebase Link Bio inicializado correctamente");
    } catch (error) {
        if (error.code === 'app/duplicate-app') {
            console.warn("丘멆잺 Firebase Link Bio ya estaba inicializado, reutilizando...");
            // Si ya existe, obtenerla
            const { getApp } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js");
            linkBioApp = getApp("linkBioApp");
            linkBioDb = getFirestore(linkBioApp);
        } else {
            console.error("仇 Error inicializando Firebase Link Bio:", error);
            throw error;
        }
    }
    
    // ============================================
    // FUNCIONES DE SINCRONIZACI칍N CON LINK BIO
    // ============================================
    
    /**
     * Verifica si los n칰meros est치n disponibles en Link Bio
     */
    async function verificarDisponibilidadLinkBio(numeros) {
        try {
            const rifaRef = doc(linkBioDb, "rifas", "rifa_1000");
            const rifaSnap = await getDoc(rifaRef);
            
            if (!rifaSnap.exists()) {
                // 游댠 CORRECCI칍N 2: Usar setDoc en lugar de updateDoc para crear
                await setDoc(rifaRef, {
                    vendidos: 0,
                    numerosVendidos: [],
                    fechaActualizacion: serverTimestamp(),
                    nombre: "SB Din치micas Premium 1000",
                    precioBoleto: window.db.price || 20000,
                    totalNumeros: 1000,
                    fechaCreacion: serverTimestamp()
                });
                console.log("九 Rifa creada en Link Bio");
                return { disponibles: true, noDisponibles: [] };
            }
            
            const numerosVendidos = rifaSnap.data().numerosVendidos || [];
            const noDisponibles = numeros.filter(n => numerosVendidos.includes(parseInt(n)));
            
            return {
                disponibles: noDisponibles.length === 0,
                noDisponibles: noDisponibles
            };
        } catch (error) {
            console.error("Error verificando en Link Bio:", error);
            // 游댠 CORRECCI칍N 3: Retornar disponibles en caso de error de red
            return { disponibles: true, noDisponibles: [], error: true };
        }
    }
    
    /**
     * Guarda una compra en Link Bio y actualiza contadores
     */
    async function sincronizarConLinkBio(datos) {
        const { nombre, telefono, numeros, montoTotal, ciudad } = datos;
        
        try {
            console.log("游댃 Iniciando sincronizaci칩n con Link Bio...", { numeros, nombre });
            
            // 1. Verificar disponibilidad
            const verificacion = await verificarDisponibilidadLinkBio(numeros);
            if (!verificacion.disponibles) {
                throw new Error(`N칰meros no disponibles en otras apps: ${verificacion.noDisponibles.join(', ')}`);
            }
            
            // 2. Guardar compra del cliente en Link Bio
            const compraRef = await addDoc(collection(linkBioDb, "compradores"), {
                nombre: nombre,
                telefono: telefono,
                numeros: numeros.map(n => parseInt(n)),
                rifa: 'rifa_1000',
                monto: montoTotal,
                fecha: serverTimestamp(),
                appOrigen: 'SB_DINAMICAS_PREMIUM',
                ciudad: ciudad || "No especificada",
                estado: 'pendiente',
                pagado: false,
                timestamp: Date.now()
            });
            
            console.log("九 Compra guardada en Link Bio:", compraRef.id);
            
            // 3. Actualizar contador de la rifa en tiempo real
            await updateDoc(doc(linkBioDb, "rifas", "rifa_1000"), {
                vendidos: increment(numeros.length),
                numerosVendidos: arrayUnion(...numeros.map(n => parseInt(n))),
                ultimaActualizacion: serverTimestamp(),
                totalRecaudado: increment(montoTotal)
            });
            
            console.log("九 Contadores actualizados en Link Bio");
            return { success: true, id: compraRef.id };
            
        } catch (error) {
            console.error("仇 Error sincronizando con Link Bio:", error);
            throw error;
        }
    }
    
    /**
     * CARGA TODOS LOS DATOS DESDE LINK BIO - FUNCI칍N CR칈TICA CORREGIDA
     */
    async function cargarDatosDesdeLinkBio() {
        try {
            console.log("游닌 Cargando datos desde Link Bio...");
            actualizarEstadoSincronizacion('sincronizando', 'Cargando datos...');
            
            // 1. Obtener datos de la rifa principal
            const rifaRef = doc(linkBioDb, "rifas", "rifa_1000");
            const rifaSnap = await getDoc(rifaRef);
            
            if (!rifaSnap.exists()) {
                console.log("丘멆잺 No existe rifa en Link Bio, creando...");
                // 游댠 CORRECCI칍N 4: Usar setDoc para crear
                await setDoc(rifaRef, {
                    vendidos: 0,
                    numerosVendidos: [],
                    fechaCreacion: serverTimestamp(),
                    nombre: "SB Din치micas Premium 1000",
                    precioBoleto: window.db.price || 20000,
                    totalNumeros: 1000
                });
                
                actualizarEstadoSincronizacion('exito', 'Link Bio configurado');
                return {};
            }
            
            const rifaData = rifaSnap.data();
            const numerosVendidosLinkBio = rifaData.numerosVendidos || [];
            
            console.log(`游늵 Link Bio tiene ${numerosVendidosLinkBio.length} n칰meros vendidos`);
            
            // 2. Obtener todos los compradores ordenados por fecha
            const compradoresRef = collection(linkBioDb, "compradores");
            
            // 游댠 CORRECCI칍N 5: Manejo de error en query
            let querySnapshot;
            try {
                const q = query(
                    compradoresRef, 
                    where("rifa", "==", "rifa_1000"),
                    orderBy("timestamp", "desc")
                );
                querySnapshot = await getDocs(q);
            } catch (queryError) {
                // Si falla el orderBy (falta 칤ndice), intentar sin ordenar
                console.warn("丘멆잺 Error en query ordenado, intentando sin orderBy:", queryError);
                const q = query(
                    compradoresRef, 
                    where("rifa", "==", "rifa_1000")
                );
                querySnapshot = await getDocs(q);
            }
            
            console.log(`游늶 Compradores encontrados: ${querySnapshot.size}`);
            
            // 3. Sincronizar con base de datos local
            let vendidosActualizados = {};
            let cambios = 0;
            
            querySnapshot.forEach((docSnap) => {
                const compra = docSnap.data();
                const numerosComprados = compra.numeros || [];
                const fechaCompra = compra.fecha?.toDate?.() || new Date();
                
                numerosComprados.forEach(numero => {
                    const numStr = numero.toString().padStart(3, '0');
                    
                    // Solo actualizar si no existe localmente o si no est치 sincronizado
                    if (!window.db.soldNumbers[numStr] || 
                        (window.db.soldNumbers[numStr] && !window.db.soldNumbers[numStr].sincronizadoLinkBio)) {
                        
                        vendidosActualizados[numStr] = {
                            nombre: compra.nombre || "Cliente Link Bio",
                            ciudad: compra.ciudad || "No especificada",
                            celular: compra.telefono || "Sin tel칠fono",
                            pagado: compra.pagado || false,
                            fecha: fechaCompra.toISOString(),
                            sincronizadoLinkBio: true,
                            idLinkBio: docSnap.id,
                            fuente: "link_bio",
                            estado: compra.estado || 'pendiente'
                        };
                        cambios++;
                    }
                });
            });
            
            console.log(`游댃 Cambios detectados: ${cambios}`);
            
            // 4. Aplicar cambios si hay diferencias
            const numerosLocales = Object.keys(window.db.soldNumbers || {});
            const numerosLocalesCount = numerosLocales.length;
            const numerosLinkBioCount = numerosVendidosLinkBio.length;
            
            if (cambios > 0 || numerosLinkBioCount !== numerosLocalesCount) {
                console.log(`游댃 Sincronizando ${cambios} n칰meros desde Link Bio`);
                
                // Fusionar datos
                const nuevosSoldNumbers = { ...window.db.soldNumbers };
                
                Object.keys(vendidosActualizados).forEach(num => {
                    if (!nuevosSoldNumbers[num] || 
                        (nuevosSoldNumbers[num] && !nuevosSoldNumbers[num].sincronizadoLinkBio)) {
                        nuevosSoldNumbers[num] = vendidosActualizados[num];
                    }
                });
                
                // Actualizar la base de datos local
                window.db.soldNumbers = nuevosSoldNumbers;
                window.db.lastSync = new Date().toISOString();
                
                // Guardar cambios
                localStorage.setItem('sb_dinamicas_premium_db', JSON.stringify(window.db));
                
                // Actualizar UI
                if (window.updateUI) {
                    window.updateUI();
                }
                
                actualizarEstadoSincronizacion('exito', `Sincronizado: ${numerosLinkBioCount} n칰meros`);
                if (window.showNotification) {
                    window.showNotification(`九 Link Bio: ${numerosLinkBioCount} n칰meros cargados`, "success");
                }
                
                console.log("九 Sincronizaci칩n completada");
                return nuevosSoldNumbers;
            } else {
                actualizarEstadoSincronizacion('exito', 'Datos actualizados');
                console.log("九 Datos ya est치n sincronizados");
                return window.db.soldNumbers;
            }
            
        } catch (error) {
            console.error("仇 Error cargando datos de Link Bio:", error);
            actualizarEstadoSincronizacion('error', 'Error de conexi칩n');
            if (window.showNotification) {
                window.showNotification("丘멆잺 Error sincronizando con Link Bio", "warning");
            }
            return {};
        }
    }
    
    /**
     * Actualiza el estado de sincronizaci칩n
     */
    function actualizarEstadoSincronizacion(estado, mensaje = "") {
        const syncElement = document.getElementById('syncStatus');
        const badgeElement = document.getElementById('linkBioSyncBadge');
        
        if (!syncElement) return;
        
        syncElement.className = 'sync-status';
        syncElement.style.display = 'flex';
        
        switch(estado) {
            case 'conectando':
                syncElement.classList.add('sync-warning');
                syncElement.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Conectando con Link Bio...';
                if (badgeElement) {
                    badgeElement.style.display = 'inline-block';
                    badgeElement.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Conectando...';
                }
                break;
                
            case 'sincronizando':
                syncElement.classList.add('sync-warning');
                syncElement.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> ${mensaje || 'Sincronizando...'}`;
                if (badgeElement) {
                    badgeElement.style.display = 'inline-block';
                    badgeElement.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Sync';
                }
                break;
                
            case 'exito':
                syncElement.classList.add('sync-online');
                syncElement.innerHTML = `<i class="fas fa-check-circle"></i> ${mensaje || 'Sincronizado con Link Bio'}`;
                if (badgeElement) {
                    badgeElement.style.display = 'inline-block';
                    badgeElement.innerHTML = '<i class="fas fa-link"></i> Link Bio';
                    badgeElement.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                }
                
                setTimeout(() => {
                    syncElement.style.display = 'none';
                }, 3000);
                break;
                
            case 'error':
                syncElement.classList.add('sync-error');
                syncElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${mensaje || 'Error de sincronizaci칩n'}`;
                if (badgeElement) {
                    badgeElement.style.display = 'inline-block';
                    badgeElement.innerHTML = '<i class="fas fa-unlink"></i> Offline';
                    badgeElement.style.background = 'linear-gradient(135deg, #f43f5e, #e11d48)';
                }
                
                setTimeout(() => {
                    syncElement.style.display = 'none';
                }, 5000);
                break;
                
            case 'ocultar':
                syncElement.style.display = 'none';
                if (badgeElement) badgeElement.style.display = 'none';
                break;
        }
    }
    
    /**
     * Sistema de sincronizaci칩n autom치tica CORREGIDO
     */
    let syncInterval = null;
    let isFirstSync = true;
    
    function iniciarSincronizacionAutomatica() {
        // Detener intervalo anterior si existe
        if (syncInterval) clearInterval(syncInterval);
        
        // 游댠 CORRECCI칍N 6: Sincronizar inmediatamente solo si es la primera vez
        if (isFirstSync) {
            console.log("游댃 Primera sincronizaci칩n con Link Bio...");
            setTimeout(async () => {
                try {
                    await cargarDatosDesdeLinkBio();
                    isFirstSync = false;
                } catch (error) {
                    console.warn("Error en primera sincronizaci칩n:", error);
                }
            }, 2000); // Esperar 2 segundos para que todo est칠 cargado
        }
        
        // Sincronizar cada 30 segundos (aumentado de 20)
        syncInterval = setInterval(async () => {
            try {
                console.log("游댃 Sincronizaci칩n autom치tica...");
                await cargarDatosDesdeLinkBio();
            } catch (error) {
                console.warn("Error en sincronizaci칩n autom치tica:", error);
            }
        }, 30000); // 30 segundos
        
        console.log("游댃 Sincronizaci칩n autom치tica activada (30s)");
    }
    
    function detenerSincronizacionAutomatica() {
        if (syncInterval) {
            clearInterval(syncInterval);
            syncInterval = null;
            console.log("낓勇 Sincronizaci칩n autom치tica detenida");
        }
    }
    
    /**
     * Test de conexi칩n con Link Bio MEJORADO
     */
    async function testConexionLinkBio() {
        try {
            console.log("游댌 Probando conexi칩n con Link Bio...");
            actualizarEstadoSincronizacion('conectando');
            
            const rifaRef = doc(linkBioDb, "rifas", "rifa_1000");
            const rifaSnap = await getDoc(rifaRef);
            
            if (rifaSnap.exists()) {
                console.log("九 Conexi칩n exitosa con Link Bio");
                actualizarEstadoSincronizacion('exito', 'Conectado a Link Bio');
                return true;
            } else {
                console.log("丘멆잺 Rifa no existe, creando...");
                await setDoc(rifaRef, {
                    vendidos: 0,
                    numerosVendidos: [],
                    fechaCreacion: serverTimestamp(),
                    nombre: "SB Din치micas Premium 1000",
                    precioBoleto: window.db?.price || 20000,
                    totalNumeros: 1000
                });
                
                console.log("九 Rifa creada en Link Bio");
                actualizarEstadoSincronizacion('exito', 'Link Bio configurado');
                return true;
            }
        } catch (error) {
            console.error("仇 Error conectando con Link Bio:", error);
            actualizarEstadoSincronizacion('error', 'Sin conexi칩n a Link Bio');
            return false;
        }
    }
    
    // Exportar funciones globalmente
    window.verificarDisponibilidadLinkBio = verificarDisponibilidadLinkBio;
    window.sincronizarConLinkBio = sincronizarConLinkBio;
    window.cargarDatosDesdeLinkBio = cargarDatosDesdeLinkBio;
    window.actualizarEstadoSincronizacion = actualizarEstadoSincronizacion;
    window.iniciarSincronizacionAutomatica = iniciarSincronizacionAutomatica;
    window.detenerSincronizacionAutomatica = detenerSincronizacionAutomatica;
    window.testConexionLinkBio = testConexionLinkBio;
    
    // 游댠 CORRECCI칍N 7: Iniciar despu칠s de que el DOM est칠 listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                console.log("游 Iniciando sistema de sincronizaci칩n...");
                testConexionLinkBio().then(conectado => {
                    if (conectado) {
                        iniciarSincronizacionAutomatica();
                    }
                });
            }, 3000);
        });
    } else {
        setTimeout(() => {
            console.log("游 Iniciando sistema de sincronizaci칩n...");
            testConexionLinkBio().then(conectado => {
                if (conectado) {
                    iniciarSincronizacionAutomatica();
                }
            });
        }, 3000);
    }
    
</script>
    
    <!-- APP PRINCIPAL CON TODAS LAS CORRECCIONES -->
    <script>
        // =============================================
        // CONFIGURACI칍N Y VARIABLES GLOBALES
        // =============================================
        const TOTAL_NUMBERS = 1000;
        let WHATSAPP_NUMBER = "";
        let selected = [];
        let isFirebaseReady = true;
        let unsubscribeFirestore = null;
        let lastSearchTerm = '';
        let highlightedNumbers = [];
        let adminPanelRef = null;
        
        // BASE DE DATOS LOCAL
        window.db = JSON.parse(localStorage.getItem('sb_dinamicas_premium_db')) || {
            prize: "游꿀 Sorteo Premium SB Din치micas",
            desc: "Participa por incre칤bles premios en nuestro sorteo exclusivo",
            price: 20000,
            img: "",
            soldNumbers: {},
            lastSync: null,
            isAdmin: false,
            whatsappNumber: "",
            configVersion: "1.0.0",
            configCompleta: {
                fechaSorteo: null,
                piePagina: "",
                colorPrincipal: "#6366f1"
            }
        };
        
        // =============================================
        // FUNCIONES DE UTILIDAD
        // =============================================
        
        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.classList.add('hidden'), 400);
            }, duration);
        }
        
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function isValidWhatsAppNumber(number) {
            return /^57\d{10}$/.test(number);
        }
        
        function formatMoney(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // =============================================
        // FUNCIONES DE WHATSAPP
        // =============================================
        
        function initWhatsAppNumber() {
            if (window.db.whatsappNumber && isValidWhatsAppNumber(window.db.whatsappNumber)) {
                WHATSAPP_NUMBER = window.db.whatsappNumber;
                updateWhatsAppStatus();
                hideWhatsAppAlert();
                return true;
            }
            
            const savedNumber = localStorage.getItem('sb_whatsapp_number');
            if (savedNumber && isValidWhatsAppNumber(savedNumber)) {
                WHATSAPP_NUMBER = savedNumber;
                window.db.whatsappNumber = savedNumber;
                save();
                updateWhatsAppStatus();
                hideWhatsAppAlert();
                return true;
            }
            
            showWhatsAppAlert();
            WHATSAPP_NUMBER = "";
            updateWhatsAppStatus();
            return false;
        }
        
        function updateWhatsAppStatus() {
            const statusEl = document.getElementById('whatsappCurrent');
            if (statusEl) {
                if (WHATSAPP_NUMBER) {
                    const formatted = WHATSAPP_NUMBER.replace(/^57/, '+57 ');
                    statusEl.innerHTML = `
                        <div style="color: var(--success);">
                            <i class="fas fa-check-circle"></i> Configurado correctamente
                        </div>
                        <div style="margin-top: 5px; font-size: 0.85rem;">
                            N칰mero: <strong>${formatted}</strong>
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <div style="color: var(--accent);">
                            <i class="fas fa-exclamation-triangle"></i> No configurado
                        </div>
                        <div style="margin-top: 5px; font-size: 0.85rem;">
                            Configura un n칰mero para recibir reservas
                        </div>
                    `;
                }
            }
        }
        
        function showWhatsAppAlert() {
            const alertEl = document.getElementById('whatsappAlert');
            if (alertEl) alertEl.classList.remove('hidden');
        }
        
        function hideWhatsAppAlert() {
            const alertEl = document.getElementById('whatsappAlert');
            if (alertEl) alertEl.classList.add('hidden');
        }
        
        function saveWhatsAppConfig() {
            const numberInput = document.getElementById('whatsappConfig').value.trim();
            const statusEl = document.getElementById('whatsappStatus');
            
            if (!isValidWhatsAppNumber(numberInput)) {
                showStatus(statusEl, "仇 Formato inv치lido. Usa: 57 + 10 d칤gitos", "error");
                return;
            }
            
            WHATSAPP_NUMBER = numberInput;
            localStorage.setItem('sb_whatsapp_number', numberInput);
            window.db.whatsappNumber = numberInput;
            save();
            
            hideWhatsAppAlert();
            showStatus(statusEl, "九 WhatsApp configurado exitosamente", "success");
            updateWhatsAppStatus();
            showNotification("N칰mero de WhatsApp actualizado", "success");
        }
        
        function showStatus(element, message, type) {
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                element.style.background = type === 'success' 
                    ? 'rgba(34, 197, 94, 0.1)' 
                    : 'rgba(244, 63, 94, 0.1)';
                element.style.border = type === 'success' 
                    ? '1px solid rgba(34, 197, 94, 0.3)' 
                    : '1px solid rgba(244, 63, 94, 0.3)';
                element.style.color = type === 'success' ? '#22c55e' : '#f43f5e';
                
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
        
        // =============================================
        // FUNCIONES PARA CONFIGURACI칍N COMPLETA
        // =============================================
        
        function cargarConfiguracionActual() {
            console.log("Cargando configuraci칩n actual...");
            
            document.getElementById('configTitulo').value = window.db.prize || "";
            document.getElementById('configDescripcion').value = window.db.desc || "";
            document.getElementById('configValor').value = window.db.price || 20000;
            
            if (window.db.configCompleta) {
                const config = window.db.configCompleta;
                document.getElementById('configFecha').value = config.fechaSorteo || "";
                document.getElementById('configPiePagina').value = config.piePagina || "";
                document.getElementById('configColorPrincipal').value = config.colorPrincipal || "#6366f1";
            } else {
                const fechaPredeterminada = new Date();
                fechaPredeterminada.setDate(fechaPredeterminada.getDate() + 30);
                document.getElementById('configFecha').value = fechaPredeterminada.toISOString().slice(0, 16);
                document.getElementById('configPiePagina').value = " El sorteo se realizar치 de forma transparente y ser치 transmitido en vivo.\n Los ganadores ser치n notificados por WhatsApp.\n Para reclamar premios mayores a $500,000 se requiere identificaci칩n.";
            }
            
            if (window.db.img) {
                const previewImg = document.getElementById('configImagenPreviewImg');
                previewImg.src = window.db.img;
                document.getElementById('configImagenPreview').style.display = 'block';
            }
            
            actualizarVistaPrevia();
            showNotification("Configuraci칩n actual cargada", "success");
        }
        
        function uploadConfigImage(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification("La imagen no debe superar 5MB", "error");
                return;
            }
            
            if (!file.type.match('image.*')) {
                showNotification("Solo se permiten im치genes", "error");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => { 
                window.db.img = e.target.result;
                
                const previewImg = document.getElementById('configImagenPreviewImg');
                previewImg.src = e.target.result;
                document.getElementById('configImagenPreview').style.display = 'block';
                
                actualizarVistaPrevia();
                
                showNotification("Imagen cargada exitosamente", "success");
            };
            reader.onerror = () => {
                showNotification("Error al cargar la imagen", "error");
            };
            reader.readAsDataURL(file);
        }
        
        function guardarConfiguracionCompleta() {
            const titulo = document.getElementById('configTitulo').value.trim();
            const descripcion = document.getElementById('configDescripcion').value.trim();
            const valor = parseInt(document.getElementById('configValor').value);
            const fecha = document.getElementById('configFecha').value;
            const piePagina = document.getElementById('configPiePagina').value.trim();
            const colorPrincipal = document.getElementById('configColorPrincipal').value;
            
            const statusEl = document.getElementById('configCompletaStatus');
            
            if (!titulo || titulo.length < 5) {
                showStatus(statusEl, "仇 El t칤tulo debe tener al menos 5 caracteres", "error");
                return;
            }
            
            if (!descripcion || descripcion.length < 10) {
                showStatus(statusEl, "仇 La descripci칩n debe tener al menos 10 caracteres", "error");
                return;
            }
            
            if (!valor || valor < 1000) {
                showStatus(statusEl, "仇 El valor debe ser m칤nimo $1,000 COP", "error");
                return;
            }
            
            if (!fecha) {
                showStatus(statusEl, "仇 Selecciona una fecha para el sorteo", "error");
                return;
            }
            
            window.db.prize = escapeHTML(titulo);
            window.db.desc = escapeHTML(descripcion);
            window.db.price = valor;
            
            window.db.configCompleta = {
                fechaSorteo: fecha,
                piePagina: escapeHTML(piePagina),
                colorPrincipal: colorPrincipal,
                ultimaActualizacion: new Date().toISOString()
            };
            
            if (colorPrincipal && colorPrincipal !== "#6366f1") {
                aplicarColorPersonalizado(colorPrincipal);
            }
            
            save();
            
            showStatus(statusEl, "九 Configuraci칩n completa guardada exitosamente", "success");
            showNotification("Configuraci칩n del sorteo actualizada", "success");
            
            actualizarVistaPrevia();
            updateUI();
            
            setTimeout(() => {
                showTab('admin-panel');
            }, 1500);
        }
        
        function aplicarColorPersonalizado(color) {
            document.documentElement.style.setProperty('--primary', color);
            
            const colorOscuro = oscurecerColor(color, 20);
            document.documentElement.style.setProperty('--primary-dark', colorOscuro);
            document.documentElement.style.setProperty('--color-seleccionado', color);
            
            console.log("Color personalizado aplicado:", color);
        }
        
        function oscurecerColor(color, porcentaje) {
            let r = parseInt(color.substr(1, 2), 16);
            let g = parseInt(color.substr(3, 2), 16);
            let b = parseInt(color.substr(5, 2), 16);
            
            r = Math.floor(r * (100 - porcentaje) / 100);
            g = Math.floor(g * (100 - porcentaje) / 100);
            b = Math.floor(b * (100 - porcentaje) / 100);
            
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        
        function actualizarVistaPrevia() {
            const titulo = document.getElementById('configTitulo').value || "[Sin t칤tulo]";
            const descripcion = document.getElementById('configDescripcion').value || "[Sin descripci칩n]";
            const valor = document.getElementById('configValor').value || "0";
            const fecha = document.getElementById('configFecha').value;
            const piePagina = document.getElementById('configPiePagina').value || "[Sin informaci칩n adicional]";
            
            let fechaFormateada = "No configurada";
            if (fecha) {
                const fechaObj = new Date(fecha);
                fechaFormateada = fechaObj.toLocaleDateString('es-CO', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            const previewHTML = `
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <div style="font-size: 1.4rem; font-weight: 800; color: white; margin-bottom: 10px;">
                        ${escapeHTML(titulo)}
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: 15px; line-height: 1.5;">
                        ${escapeHTML(descripcion.replace(/\n/g, '<br>'))}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: var(--warning); font-size: 0.9rem;">Valor por boleto:</div>
                            <div style="font-size: 1.8rem; font-weight: 800; color: white;">
                                $${parseInt(valor).toLocaleString('es-CO')} COP
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: var(--primary); font-size: 0.9rem;">
                                <i class="fas fa-calendar-alt"></i> ${fechaFormateada}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.4;">
                        ${escapeHTML(piePagina.replace(/\n/g, '<br>'))}
                    </div>
                </div>
                
                ${window.db.img ? `
                <div style="margin-top: 15px;">
                    <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">Imagen del premio:</div>
                    <img src="${window.db.img}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid var(--glass-border);">
                </div>
                ` : ''}
                
                <div style="margin-top: 15px; font-size: 0.75rem; color: var(--text-secondary);">
                    <i class="fas fa-info-circle"></i> Esta es una vista previa de c칩mo ver치n los participantes el sorteo.
                </div>
            `;
            
            document.getElementById('configPreview').innerHTML = previewHTML;
        }
        
        function actualizarContadorSorteo() {
            if (window.db.configCompleta && window.db.configCompleta.fechaSorteo) {
                const fechaSorteo = new Date(window.db.configCompleta.fechaSorteo);
                const ahora = new Date();
                const diferenciaMs = fechaSorteo - ahora;
                
                if (diferenciaMs > 0) {
                    const dias = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24));
                    const horas = Math.floor((diferenciaMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    
                    let contadorEl = document.getElementById('contadorSorteo');
                    if (!contadorEl) {
                        const panelPremio = document.querySelector('#view-user .glass-effect');
                        if (panelPremio) {
                            contadorEl = document.createElement('div');
                            contadorEl.id = 'contadorSorteo';
                            contadorEl.style.marginTop = '15px';
                            contadorEl.style.padding = '15px';
                            contadorEl.style.background = 'rgba(99, 102, 241, 0.1)';
                            contadorEl.style.borderRadius = '12px';
                            contadorEl.style.border = '1px solid rgba(99, 102, 241, 0.2)';
                            contadorEl.style.textAlign = 'center';
                            panelPremio.appendChild(contadorEl);
                        }
                    }
                    
                    if (contadorEl) {
                        contadorEl.innerHTML = `
                            <div style="color: var(--primary); font-weight: 600; margin-bottom: 5px;">
                                <i class="fas fa-clock"></i> SORTEO EN:
                            </div>
                            <div style="font-size: 1.8rem; font-weight: 800; color: white;">
                                ${dias} D칈AS ${horas} HRS
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">
                                ${fechaSorteo.toLocaleDateString('es-CO', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                        `;
                    }
                }
            }
        }
        
        // =============================================
        // FUNCIONES PRINCIPALES DE LA APLICACI칍N
        // =============================================
        
        function showTab(tab) {
            const views = ['user', 'admin-login', 'admin-panel', 'admin-config'];
            views.forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (el) {
                    el.classList.add('hidden');
                    if (v !== 'user') el.classList.remove('fade-in');
                }
            });
            
            const target = document.getElementById(`view-${tab}`);
            if (target) {
                target.classList.remove('hidden');
                if (tab !== 'user') target.classList.add('fade-in');
            }
            
            if (tab === 'admin-config' && window.db.isAdmin) {
                cargarConfiguracionActual();
            }
            
            if (tab === 'user') {
                clearSearch();
            }
            
            updateUI();
        }
        
        function searchNumbers() {
            const searchTerm = document.getElementById('numberSearch').value.trim();
            if (!searchTerm) { return clearSearch(); }
            
            const items = document.querySelectorAll('.number-item');
            items.forEach(item => {
                const num = item.id.replace('num-', '');
                if (num.includes(searchTerm)) {
                    item.style.display = 'flex';
                    item.classList.add('highlighted');
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function clearSearch() {
            document.getElementById('numberSearch').value = '';
            lastSearchTerm = '';
            highlightedNumbers.forEach(num => {
                const element = document.getElementById(`num-${num}`);
                if (element) element.classList.remove('highlighted');
            });
            highlightedNumbers = [];
            document.getElementById('searchResultsInfo').classList.add('hidden');
            initGrid();
        }
        
        function initGrid() {
            const grid = document.getElementById('mainGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            for(let i = 0; i < TOTAL_NUMBERS; i++) {
                const n = i.toString().padStart(3, '0');
                const div = document.createElement('div');
                
                let estado = '';
                if(window.db.soldNumbers[n]) {
                    estado = window.db.soldNumbers[n].pagado ? ' pagado' : ' apartado';
                }
                
                const isSelected = selected.includes(n);
                const isHighlighted = highlightedNumbers.includes(n);
                
                div.className = 'number-item' + estado + (isSelected ? ' selected' : '') + (isHighlighted ? ' highlighted' : '');
                div.id = `num-${n}`;
                div.textContent = n;
                div.onclick = () => toggleNumber(n);
                
                if (window.db.soldNumbers[n]) {
                    const badge = document.createElement('span');
                    badge.className = 'number-badge';
                    badge.textContent = window.db.soldNumbers[n].pagado ? 'P' : 'A';
                    div.appendChild(badge);
                }
                
                grid.appendChild(div);
            }
        }
        
        function toggleNumber(n) {
            if(window.db.soldNumbers[n]) {
                const numeroData = window.db.soldNumbers[n];
                if (numeroData.pagado) {
                    showNotification("Este n칰mero ya est치 pagado", "error");
                } else {
                    showNotification(`N칰mero ${n} apartado por ${numeroData.nombre}`, "warning");
                }
                return;
            }
            
            const idx = selected.indexOf(n);
            if(idx > -1) {
                selected.splice(idx, 1);
            } else {
                if(selected.length >= 20) {
                    showNotification("M치ximo 20 n칰meros por transacci칩n", "warning");
                    return;
                }
                selected.push(n);
                
                const element = document.getElementById(`num-${n}`);
                if (element) {
                    element.classList.add('number-pop');
                    setTimeout(() => element.classList.remove('number-pop'), 500);
                }
            }
            updateUI();
        }
        
        function selectRandom(qty) {
            if(selected.length >= 20) {
                showNotification("M치ximo 20 n칰meros permitidos", "warning");
                return;
            }
            
            let libres = [];
            for(let i = 0; i < TOTAL_NUMBERS; i++) {
                const n = i.toString().padStart(3, '0');
                if(!window.db.soldNumbers[n] && !selected.includes(n)) {
                    libres.push(n);
                }
            }
            
            if(libres.length === 0) {
                showNotification("춰Todos los n칰meros est치n ocupados!", "error");
                return;
            }
            
            const espacio = 20 - selected.length;
            const finalQty = Math.min(qty, espacio, libres.length);
            
            libres.sort(() => Math.random() - 0.5);
            
            for(let i = 0; i < finalQty; i++) {
                const num = libres[i];
                setTimeout(() => {
                    if(!selected.includes(num)) {
                        selected.push(num);
                        updateUI();
                        const el = document.getElementById(`num-${num}`);
                        if(el) {
                            el.classList.add('selected');
                            el.classList.add('number-pop');
                        }
                    }
                }, i * 100);
            }
            
            showNotification(`Seleccionados ${finalQty} n칰meros al azar`, "success");
        }
        
        function clearSelection() {
            selected = [];
            updateUI();
            showNotification("Selecci칩n limpiada", "info");
        }
        
        // =============================================
        // FUNCI칍N PRINCIPAL MODIFICADA - 100% FUNCIONAL
        // =============================================
        async function sendWhatsApp() {
            if (!WHATSAPP_NUMBER || !isValidWhatsAppNumber(WHATSAPP_NUMBER)) {
                alert("WhatsApp no configurado");
                return;
            }

            const nom = document.getElementById('uNombre').value.trim();
            const ciu = document.getElementById('uCiudad').value.trim();
            let cel = document.getElementById('uCelular').value.trim();

            if (!nom || !ciu || !cel || selected.length === 0) {
                alert("Completa tus datos y selecciona n칰meros");
                return;
            }

            cel = cel.replace(/\D/g, '');
            const total = selected.length * window.db.price;
            
            // 游댃 PASO 1: VERIFICAR DISPONIBILIDAD EN TIEMPO REAL
            try {
                actualizarEstadoSincronizacion('sincronizando', 'Verificando disponibilidad...');
                
                // Verificar localmente primero
                const numerosNoDisponibles = [];
                selected.forEach(num => {
                    if (window.db.soldNumbers && window.db.soldNumbers[num]) {
                        numerosNoDisponibles.push(num);
                    }
                });
                
                if (numerosNoDisponibles.length > 0) {
                    actualizarEstadoSincronizacion('error', `N칰meros ocupados: ${numerosNoDisponibles.join(', ')}`);
                    alert(`丘멆잺 Estos n칰meros ya est치n vendidos: ${numerosNoDisponibles.join(', ')}\n\nPor favor selecciona otros n칰meros.`);
                    
                    selected = selected.filter(num => !numerosNoDisponibles.includes(num));
                    updateUI();
                    return;
                }
                
                // 游댃 PASO 2: SINCRONIZAR CON LINK BIO
                actualizarEstadoSincronizacion('sincronizando', 'Registrando en Link Bio...');
                
                const resultado = await window.sincronizarConLinkBio({
                    nombre: nom,
                    telefono: cel,
                    numeros: selected,
                    montoTotal: total,
                    ciudad: ciu
                });
                
                actualizarEstadoSincronizacion('exito', 'Sincronizado con Link Bio');
                console.log("九 Compra sincronizada con ID:", resultado.id);
                
                // 游댃 PASO 3: ACTUALIZAR BASE DE DATOS LOCAL INMEDIATAMENTE
                const fecha = new Date().toISOString();
                selected.forEach(n => {
                    window.db.soldNumbers[n] = {
                        nombre: nom,
                        ciudad: ciu,
                        celular: cel,
                        pagado: false,
                        fecha: fecha,
                        sincronizadoLinkBio: true,
                        idLinkBio: resultado.id,
                        fuente: "local_sync",
                        estado: 'pendiente'
                    };
                });
                
                save();
                
                // 游댠 PASO 4: ENVIAR MENSAJE DE WHATSAPP
                const msg = encodeURIComponent(
                    `九 RESERVA CONFIRMADA - SB DIN츼MICAS\n\n` +
                    `游녻 Nombre: ${nom}\n` +
                    `游늸 Ciudad: ${ciu}\n` +
                    `游님 Celular: ${cel}\n\n` +
                    `游꿞 N칰meros: ${selected.join(', ')}\n` +
                    `游눯 Total a pagar: ${formatMoney(total)}\n\n` +
                    `낋 Tienes 24 horas para realizar el pago.\n` +
                    `游늶 N칰mero de reserva: ${resultado.id.slice(0, 8)}`
                );

                const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
                
                // Abrir WhatsApp en nueva pesta침a
                window.open(url, '_blank');
                
                showNotification(`九 Reserva confirmada: ${selected.length} n칰mero(s)`, "success");
                
                // Limpiar selecci칩n y formulario
                selected = [];
                document.getElementById('uNombre').value = '';
                document.getElementById('uCiudad').value = '';
                document.getElementById('uCelular').value = '';
                updateUI();
                
                // Forzar actualizaci칩n de datos despu칠s de 2 segundos
                setTimeout(() => {
                    if (window.cargarDatosDesdeLinkBio) {
                        window.cargarDatosDesdeLinkBio();
                    }
                }, 2000);
                
            } catch (error) {
                console.error("仇 Error en proceso completo:", error);
                actualizarEstadoSincronizacion('error', 'Error en la reserva');
                
                if (error.message.includes('N칰meros no disponibles')) {
                    showNotification("仇 Algunos n칰meros ya est치n ocupados", "error");
                } else {
                    showNotification("仇 Error al procesar la reserva", "error");
                }
            }
        }
        
        function updateUI() {
            document.getElementById('displayPrizeTitle').textContent = window.db.prize || "Sorteo";
            document.getElementById('displayPrizeDesc').textContent = window.db.desc || "";
            document.getElementById('displayPrice').textContent = (window.db.price || 0).toLocaleString('es-CO');
            
            const imgContainer = document.getElementById('prizeImageContainer');
            const imgEl = document.getElementById('displayPrizeImg');
            if(window.db.img) {
                imgEl.src = window.db.img;
                imgContainer.style.display = 'block';
            } else {
                imgContainer.style.display = 'none';
            }
            
            initGrid();
            
            if (lastSearchTerm) {
                searchNumbers();
            }
            
            const summaryEl = document.getElementById('selectionSummary');
            const countBadge = document.getElementById('selectedCountBadge');
            if(selected.length > 0) {
                const total = selected.length * window.db.price;
                summaryEl.innerHTML = `
                    <div style="font-size: 1.1rem; color: white; margin-bottom: 8px;">
                        <strong>${selected.length} n칰mero(s) seleccionado(s)</strong>
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9rem;">
                        ${selected.join(', ')}
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), transparent); padding: 15px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">
                        <div style="font-size: 1.8rem; font-weight: 800; color: var(--success);">
                            ${formatMoney(total)}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            Total a pagar
                        </div>
                    </div>
                `;
                countBadge.textContent = selected.length;
                countBadge.style.display = 'inline-block';
            } else {
                summaryEl.innerHTML = `
                    <div style="color: var(--text-secondary); font-size: 0.95rem;">
                        <i class="fas fa-mouse-pointer"></i> Haz clic en los n칰meros para seleccionarlos
                    </div>
                `;
                countBadge.style.display = 'none';
            }
            
            actualizarContadorSorteo();
            
            if(document.getElementById('view-admin-panel') && 
               !document.getElementById('view-admin-panel').classList.contains('hidden')) {
                updateAdminPanel();
            }
        }
        
        function updateAdminPanel() {
            let totalRecaudado = 0;
            let totalPendiente = 0;
            let soldCount = Object.keys(window.db.soldNumbers).length;
            
            const table = document.getElementById('salesTable');
            const searchTerm = document.getElementById('adminSearch')?.value?.toLowerCase() || '';
            table.innerHTML = '';
            
            const sortedNumbers = Object.keys(window.db.soldNumbers).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedNumbers.forEach(n => {
                const u = window.db.soldNumbers[n];
                const match = n.includes(searchTerm) || 
                             u.nombre.toLowerCase().includes(searchTerm) || 
                             u.ciudad.toLowerCase().includes(searchTerm);
                
                if(u.pagado) {
                    totalRecaudado += window.db.price;
                } else {
                    totalPendiente += window.db.price;
                }
                
                if(match) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><b>${escapeHTML(n)}</b></td>
                        <td>
                            <div style="font-weight: 600; color: white;">${escapeHTML(u.nombre)}</div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem;">
                                <i class="fas fa-map-marker-alt"></i> ${escapeHTML(u.ciudad)}
                                <span style="margin: 0 8px;"></span>
                                <i class="fas fa-phone"></i> ${escapeHTML(u.celular)}
                            </div>
                            <div style="color: #64748b; font-size: 0.75rem; margin-top: 4px;">
                                <i class="fas fa-calendar"></i> ${new Date(u.fecha).toLocaleDateString('es-CO')}
                            </div>
                        </td>
                        <td>
                            <span class="badge ${u.pagado?'bg-paid':'bg-wait'}">
                                ${u.pagado?'PAGADO':'PENDIENTE'}
                            </span>
                        </td>
                        <td>
                            ${u.fuente === 'link_bio' ? 
                                '<span style="color:#8b5cf6; font-size:0.8rem;" title="Desde Link Bio">游깷 Link Bio</span>' : 
                                '<span style="color:#6366f6; font-size:0.8rem;" title="Local">游님 Local</span>'}
                        </td>
                        <td>
                            <div style="display:flex; gap:10px;">
                                <button onclick="sendWhatsAppCobro('${n}')" title="Enviar mensaje" style="color:#fbbf24; background:none; border:none; cursor:pointer; padding: 8px; border-radius: 8px; background: rgba(251, 191, 36, 0.1);">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                                <button onclick="togglePaid('${n}')" title="${u.pagado?'Marcar pendiente':'Marcar pagado'}" style="color:#22c55e; background:none; border:none; cursor:pointer; padding: 8px; border-radius: 8px; background: rgba(34, 197, 94, 0.1);">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                <button onclick="deleteEntry('${n}')" title="Eliminar" style="color:#f43f5e; background:none; border:none; cursor:pointer; padding: 8px; border-radius: 8px; background: rgba(244, 63, 94, 0.1);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    table.appendChild(row);
                }
            });
            
            document.getElementById('statRecaudado').textContent = formatMoney(totalRecaudado);
            document.getElementById('statPendiente').textContent = formatMoney(totalPendiente);
            
            const progressPercentage = (soldCount / TOTAL_NUMBERS) * 100;
            document.getElementById('progFill').style.width = progressPercentage + '%';
            document.getElementById('progText').textContent = 
                `${soldCount}/${TOTAL_NUMBERS} (${Math.round(progressPercentage)}%)`;
        }
        
        function sendWhatsAppCobro(n) {
            if (!window.db.soldNumbers[n]) return;
            
            const cliente = window.db.soldNumbers[n];
            const monto = window.db.price;
            const msg = encodeURIComponent(
                `Hola ${cliente.nombre},\n\n` +
                `Te recordamos el pago pendiente por el n칰mero ${n}.\n` +
                `Monto: ${formatMoney(monto)}\n` +
                `Fecha de reserva: ${new Date(cliente.fecha).toLocaleDateString('es-CO')}\n\n` +
                `Por favor realiza el pago para confirmar tu participaci칩n.`
            );
            
            window.open(`https://wa.me/57${cliente.celular}?text=${msg}`, '_blank');
        }
        
        function togglePaid(n) {
            if(!window.db.soldNumbers[n]) return;
            
            const nuevoEstado = !window.db.soldNumbers[n].pagado;
            window.db.soldNumbers[n].pagado = nuevoEstado;
            window.db.soldNumbers[n].fechaActualizacion = new Date().toISOString();
            
            save();
            showNotification(
                `N칰mero ${n} ${nuevoEstado ? 'marcado como PAGADO' : 'marcado como PENDIENTE'}`,
                nuevoEstado ? 'success' : 'warning'
            );
        }
        
        function deleteEntry(n) {
            if(!window.db.soldNumbers[n]) return;
            
            if(confirm(`쯃iberar el n칰mero ${n}?\n\nCliente: ${window.db.soldNumbers[n].nombre}`)) {
                delete window.db.soldNumbers[n];
                save();
                showNotification(`N칰mero ${n} liberado`, "info");
            }
        }
        
        function clearAllData() {
            if(confirm("丘멆잺 RESETEAR TODOS LOS DATOS?\n\nEsta acci칩n eliminar치 todas las reservas.\n\nEscribe 'RESET' para confirmar:")) {
                const confirmacion = prompt("Escribe 'RESET' para confirmar:");
                if(confirmacion === 'RESET') {
                    window.db.soldNumbers = {};
                    save();
                    showNotification("Todos los datos han sido reseteados", "info");
                } else {
                    showNotification("Reset cancelado", "warning");
                }
            }
        }
        
        function forceSync() {
            if (window.saveToFirestore && window.db.isAdmin) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="spinner"></span> SINCRONIZANDO...';
                btn.disabled = true;
                
                window.saveToFirestore()
                    .then(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        showNotification("九 Sincronizado con Firebase", "success");
                    })
                    .catch(err => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        showNotification("仇 Error sincronizando", "error");
                        console.error("Firebase sync error:", err);
                    });
            } else {
                showNotification("Inicia sesi칩n como admin para sincronizar", "warning");
            }
        }
        
        function sincronizarAhora() {
            if (window.cargarDatosDesdeLinkBio) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="spinner"></span> Sincronizando...';
                btn.disabled = true;
                
                window.cargarDatosDesdeLinkBio()
                    .then(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        showNotification("九 Datos sincronizados desde Link Bio", "success");
                    })
                    .catch(err => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        showNotification("仇 Error sincronizando", "error");
                        console.error("Link Bio sync error:", err);
                    });
            }
        }
        
        function exportToExcel() {
            let csv = 'N칰mero,Nombre,Ciudad,Celular,Estado,Fecha,Origen,Sincronizado Link Bio\n';
            
            Object.keys(window.db.soldNumbers).sort().forEach(n => {
                const u = window.db.soldNumbers[n];
                csv += `"${n}","${u.nombre}","${u.ciudad}","${u.celular}","${u.pagado?'PAGADO':'PENDIENTE'}","${u.fecha}","${u.fuente || 'local'}","${u.sincronizadoLinkBio ? 'S칈' : 'NO'}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `sorteo_linkbio_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification("Datos exportados a CSV", "success");
        }
        
        function save() {
            localStorage.setItem('sb_dinamicas_premium_db', JSON.stringify(window.db));
            
            if (window.saveToFirestore) {
                window.saveToFirestore().catch(err => {
                    console.error("Error de sincronizaci칩n:", err);
                });
            }
            updateUI();
        }

        function showInstructions() {
            const instructions = `
                游꿢 INSTRUCCIONES SB DIN츼MICAS 游꿢

                1. SELECCIONA TUS N칔MEROS
                   - Haz clic en los n칰meros disponibles
                   - Usa "Selecci칩n r치pida" para n칰meros al azar
                   - M치ximo 20 n칰meros por reserva

                2. COMPLETA TUS DATOS
                   - Nombre completo
                   - Ciudad
                   - Celular (10 d칤gitos, comienza con 3)

                3. APARTA POR WHATSAPP
                   - Se abrir치 WhatsApp con tu reserva
                   - Tienes 24 horas para pagar
                   - 九 Sincronizado autom치ticamente con Link Bio

                4. ESTADOS DE LOS N칔MEROS:
                   - 游댯 Disponible: Puedes seleccionarlo
                   - 游리 Apartado: Reservado, pendiente pago
                   - 游릭 Pagado: Confirmado, no disponible
                   - 游댮 Seleccionado: Tus n칰meros elegidos

                5. 游깷 SINCRONIZACI칍N CON LINK BIO:
                   - Todos los n칰meros se sincronizan autom치ticamente
                   - Evita duplicados entre diferentes apps
                   - Estado visible en la esquina inferior derecha

                游 Soporte: Contacta al organizador
            `;
            
            alert(instructions);
        }
        
        // =============================================
        // INICIALIZACI칍N DE LA APLICACI칍N - CORREGIDA
        // =============================================
        
        function initApp() {
            initWhatsAppNumber();
            
            updateUI();
            
            showTab('user');
            
            setTimeout(() => {
                showNotification("Bienvenido a SB Din치micas Premium 游꿀", "success", 3000);
                showNotification("Sincronizando con Link Bio... 游댃", "info", 2000);
                
                if (window.testConexionLinkBio) {
                    window.testConexionLinkBio();
                }
            }, 1000);
            
            console.log("九 App SB Din치micas Premium inicializada");
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
        
        window.hideWhatsAppAlert = hideWhatsAppAlert;
        window.showWhatsAppAlert = showWhatsAppAlert;
        window.updateUI = updateUI;
    </script>
    
    <!-- FIREBASE CON SEGURIDAD CORREGIDA -->
    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
        
        const firebaseConfig = {
    apiKey: "AIzaSyBj4J3ZsJZyp8KKnysRyYQkJ7CllrCw4Uk",
    authDomain: "sb-dinamicas.firebaseapp.com",
    projectId: "sb-dinamicas",  //  UNIFICADO
    storageBucket: "sb-dinamicas.firebasestorage.app",
    messagingSenderId: "1058846798988",
    appId: "1:1058846798988:web:e27b59f99b30bcf98977a9"
};
        
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const auth = getAuth(app);
        const docRef = doc(firestore, "rifas", "rifa_1000");

        window.saveToFirestore = async () => {
            try {
                await setDoc(docRef, {
                    prize: window.db.prize,
                    desc: window.db.desc,
                    price: window.db.price,
                    img: window.db.img || "",
                    soldNumbers: window.db.soldNumbers,
                    whatsappNumber: window.db.whatsappNumber,
                    configCompleta: window.db.configCompleta || {}
                }, { merge: true });
                console.log("游댠 Sincronizado en la nube");
            } catch (e) {
                console.error("Error guardando:", e);
            }
        };

        document.getElementById('btnLoginFirebase').onclick = async () => {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPass').value;
            
            const btn = document.getElementById('btnLoginFirebase');
            btn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                window.db.isAdmin = true;
                showNotification("九 Acceso concedido", "success");
                showTab('admin-panel');
            } catch (err) {
                showNotification("仇 Error: " + err.code, "error");
            } finally {
                btn.disabled = false;
            }
        };

        document.getElementById('btnLogout').onclick = async () => {
            await signOut(auth);
            window.db.isAdmin = false;
            showTab('user');
            location.reload();
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Admin detectado:", user.email);
                window.db.isAdmin = true;
                
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        window.db.soldNumbers = data.soldNumbers || {};
                        window.db.prize = data.prize;
                        window.db.price = data.price;
                        window.db.whatsappNumber = data.whatsappNumber;
                        window.db.configCompleta = data.configCompleta;
                        window.updateUI();
                    }
                });
            } else {
                window.db.isAdmin = false;
                getDoc(docRef).then(snap => {
                    if(snap.exists()){
                        window.db.soldNumbers = snap.data().soldNumbers || {};
                        window.updateUI();
                    }
                });
            }
        });
    </script>
    <a id="waSender" href="#" target="_blank" rel="noopener" style="display:none;"></a>
</body>
</html>
